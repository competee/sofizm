<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FallacyMania ‚Äî –•–æ—Å—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Unbounded:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#13131a;--card:#16161f;--border:#1e1e2e;
  --text:#e8e8f0;--muted:#5a5a70;
  --red:#e63946;--teal:#2a9d8f;--gold:#e9c46a;--blue:#457b9d;
}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;
  height:100vh;overflow:hidden;display:flex;flex-direction:column}
.screen{display:none;flex:1;flex-direction:column;overflow:hidden}
.screen.active{display:flex}

/* LOBBY */
#screen-lobby{padding:2rem;gap:1.5rem}
.lobby-top{display:flex;align-items:flex-start;justify-content:space-between;gap:2rem}
.game-title{font-family:'Bebas Neue',sans-serif;font-size:4rem;line-height:1;
  background:linear-gradient(135deg,#ff3c5f,#ffd166,#06d6a0);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.game-sub{font-size:.7rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase;margin-top:.25rem}
.code-block{text-align:right}
.code-label{font-size:.65rem;letter-spacing:.2em;color:var(--muted);text-transform:uppercase}
.code-val{font-family:'Bebas Neue',sans-serif;font-size:4.5rem;color:var(--gold);letter-spacing:.2em;line-height:1}
.code-url{font-size:.75rem;color:var(--muted);margin-top:.25rem}
.code-url span{color:var(--teal)}
.players-row{display:flex;gap:.75rem;flex-wrap:wrap}
.p-chip{display:flex;align-items:center;gap:.6rem;background:var(--surface);
  border:1px solid var(--border);border-radius:10px;padding:.6rem .9rem}
.p-dot{width:10px;height:10px;border-radius:50%}
.p-name{font-weight:600;font-size:.85rem}
.p-civ{font-size:.7rem;color:var(--muted);margin-top:.1rem}
.btn-start{background:var(--red);color:#fff;border:none;padding:1rem 3rem;
  font-family:'Unbounded',sans-serif;font-size:.9rem;font-weight:700;
  border-radius:10px;cursor:pointer;margin-top:auto;transition:opacity .2s;align-self:flex-start}
.btn-start:hover{opacity:.85}
.btn-start:disabled{opacity:.3;cursor:default}

/* IN-GAME LAYOUT */
#screen-game{flex-direction:column}
.top-bar{display:flex;align-items:center;gap:1rem;padding:.75rem 1.5rem;
  border-bottom:1px solid var(--border);flex-shrink:0;background:var(--surface)}
.round-pill{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--gold);
  background:var(--bg);border:1px solid var(--border);padding:.15rem .75rem;border-radius:6px}
.phase-label{font-family:'Unbounded',sans-serif;font-size:.65rem;letter-spacing:.12em;
  text-transform:uppercase;color:var(--muted)}
.timer-wrap{margin-left:auto;display:flex;align-items:center;gap:.6rem}
.timer-num{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;color:var(--gold);width:3rem;text-align:right}
.timer-track{width:120px;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.timer-fill{height:100%;background:var(--gold);transition:width .5s linear;border-radius:2px}
.btn-next{background:transparent;color:var(--muted);border:1px solid var(--border);
  padding:.5rem 1.2rem;font-family:'Unbounded',sans-serif;font-size:.65rem;font-weight:700;
  border-radius:8px;cursor:pointer;transition:all .2s;letter-spacing:.05em}
.btn-next:hover{border-color:var(--gold);color:var(--gold)}

.scores-row{display:flex;gap:.5rem;padding:.6rem 1.5rem;flex-shrink:0;
  background:var(--bg);border-bottom:1px solid var(--border);flex-wrap:wrap}
.s-chip{display:flex;align-items:center;gap:.5rem;background:var(--surface);
  border:1px solid var(--border);border-radius:8px;padding:.3rem .65rem;font-size:.75rem;min-width:110px}
.s-score{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;margin-left:auto}

.main-area{display:flex;flex:1;gap:1.25rem;padding:1.25rem 1.5rem;overflow:hidden;min-height:0}
.left-panel{display:flex;flex-direction:column;flex:1;gap:1rem;overflow:hidden;min-height:0}
.right-panel{width:320px;flex-shrink:0;display:flex;flex-direction:column;gap:.75rem;overflow-y:auto}

/* CARDS */
.card-block{background:var(--surface);border:1px solid var(--border);border-radius:14px;
  padding:1.25rem;display:flex;flex-direction:column;gap:.75rem}
.block-label{font-size:.6rem;letter-spacing:.15em;text-transform:uppercase;
  color:var(--muted);font-weight:600;margin-bottom:-.25rem}
.block-title{font-family:'Unbounded',sans-serif;font-size:1rem;font-weight:900;line-height:1.3}
.civ-badge{display:inline-flex;align-items:center;gap:.4rem;background:var(--bg);
  border:1px solid var(--border);border-radius:6px;padding:.2rem .6rem;font-size:.75rem;color:var(--muted)}

.fact-box{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:1rem}
.fact-title{font-family:'Unbounded',sans-serif;font-size:.8rem;font-weight:700;color:var(--gold);margin-bottom:.5rem}
.fact-body{font-size:.75rem;color:var(--muted);line-height:1.65}
.fact-angle-atk{font-size:.73rem;color:var(--red);border-left:2px solid var(--red);
  padding-left:.65rem;margin-top:.6rem;font-style:italic;line-height:1.5}
.fact-angle-def{font-size:.73rem;color:var(--teal);border-left:2px solid var(--teal);
  padding-left:.65rem;margin-top:.5rem;font-style:italic;line-height:1.5}

.fallacy-pill{display:inline-flex;align-items:center;gap:.5rem;
  border:1px solid;border-radius:8px;padding:.35rem .75rem;font-size:.75rem;font-weight:600;
  border-color:var(--red);color:var(--red);background:#e6394611;align-self:flex-start}

/* CIV SELECT */
.civ-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem;flex:1;align-content:start}
.civ-card{background:var(--surface);border:2px solid var(--border);border-radius:12px;padding:.9rem;text-align:center}
.civ-card.taken{border-color:var(--teal)}
.civ-em{font-size:2.2rem;display:block;margin-bottom:.4rem}
.civ-nm{font-family:'Unbounded',sans-serif;font-size:.65rem;font-weight:700;line-height:1.3}
.civ-era{font-size:.6rem;color:var(--muted);margin-top:.2rem}
.civ-who{font-size:.6rem;color:var(--teal);margin-top:.3rem;font-weight:600}

/* ATTACK ORDER LIST (right panel) */
.order-list{display:flex;flex-direction:column;gap:.4rem}
.order-item{display:flex;align-items:center;gap:.6rem;padding:.4rem .65rem;
  background:var(--bg);border-radius:7px;font-size:.75rem;opacity:.5}
.order-item.current{background:var(--surface);border:1px solid var(--red);opacity:1;font-weight:600}
.order-item.done{opacity:.3;text-decoration:line-through}
.order-idx{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--muted);width:1.2rem}

/* DEFENSE WAITING */
.big-center{flex:1;display:flex;align-items:center;justify-content:center;
  font-family:'Unbounded',sans-serif;font-size:1rem;color:var(--muted);text-align:center;flex-direction:column;gap:.75rem}
.big-icon{font-size:4rem}

/* CANCEL VOTE */
.cancel-center{text-align:center;padding:1.5rem 0}
.cancel-count{font-family:'Bebas Neue',sans-serif;font-size:4rem;color:var(--red)}
.cancel-bars{display:flex;gap:.75rem;margin-top:.75rem;justify-content:center}
.vote-bar{padding:.5rem 1.5rem;border-radius:8px;font-weight:700;font-size:.85rem;border:2px solid}
.vote-bar.red{border-color:var(--red);color:var(--red);background:#e6394622}
.vote-bar.green{border-color:var(--teal);color:var(--teal);background:#2a9d8f22}

/* RATING */
.speeches-list{display:flex;flex-direction:column;gap:.5rem;overflow-y:auto;flex:1}
.speech-row{display:flex;align-items:center;gap:.75rem;background:var(--surface);
  border:1px solid var(--border);border-radius:10px;padding:.65rem .9rem}
.speech-role{font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;
  padding:.15rem .45rem;border-radius:4px;font-weight:700}
.speech-role.atk{background:#e6394622;color:var(--red)}
.speech-role.def{background:#2a9d8f22;color:var(--teal)}
.rating-bar{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
.rating-chip{padding:.3rem .7rem;border-radius:6px;font-size:.75rem;background:var(--border)}
.rating-chip.gold{background:#e9c46a33;color:var(--gold);border:1px solid var(--gold)}
.rating-chip.silver{background:#aaa3;color:#ccc}

/* MAP */
#host-hex-svg{width:100%;height:100%;display:block}
.map-legend{display:flex;flex-direction:column;gap:.5rem}
.leg-item{display:flex;align-items:center;gap:.5rem;font-size:.75rem}
.leg-dot{width:11px;height:11px;border-radius:50%}

/* ROUND END */
.podium{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;flex:1;align-content:start}
.podium-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;
  padding:1rem;display:flex;align-items:center;gap:.9rem}
.podium-rank{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:var(--muted);width:2.5rem;text-align:center}
.podium-pts{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;margin-left:auto}

/* DEBUG */
#dbg{position:fixed;bottom:.5rem;left:.5rem;background:#111;color:#aaa;
  border:1px solid #222;border-radius:6px;padding:.3rem .65rem;font-size:.65rem;
  font-family:monospace;z-index:9999;max-width:450px}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="screen-lobby" class="screen active">
  <div class="lobby-top">
    <div>
      <div class="game-title">FallacyMania</div>
      <div class="game-sub">–¶–∏–≤—ñ–ª—ñ–∑–∞—Ü—ñ–π–Ω–∞ –±–∏—Ç–≤–∞ ¬∑ –ì—Ä–∞ —É –ª–æ–≥—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏</div>
    </div>
    <div class="code-block">
      <div class="code-label">–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏</div>
      <div class="code-val" id="room-code">----</div>
      <div class="code-url">–ó–∞–π–¥—ñ—Ç—å: <span id="join-url">‚Ä¶</span>/player.html</div>
    </div>
  </div>
  <div class="players-row" id="lobby-players">
    <div style="color:var(--muted);font-size:.85rem;padding:.5rem 0">–û—á—ñ–∫—É—î–º–æ –≥—Ä–∞–≤—Ü—ñ–≤...</div>
  </div>
  <button class="btn-start" id="btn-start" onclick="startGame()" disabled>‚ñ∂ –ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
</div>

<!-- IN-GAME -->
<div id="screen-game" class="screen">
  <div class="top-bar">
    <div class="round-pill">–†–∞—É–Ω–¥ <span id="round-num">1</span></div>
    <div class="phase-label" id="phase-label">‚Äî</div>
    <div class="timer-wrap">
      <div class="timer-track"><div class="timer-fill" id="timer-fill" style="width:100%"></div></div>
      <div class="timer-num" id="timer-num">‚Äî</div>
    </div>
    <button class="btn-next" onclick="nextPhase()">‚ñ∂ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
  </div>
  <div class="scores-row" id="scores-row"></div>
  <div class="main-area">
    <div class="left-panel" id="left-panel"></div>
    <div class="right-panel" id="right-panel"></div>
  </div>
</div>

<div id="dbg">üü° –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>

<script>
const WS_URL = location.protocol==='https:'
  ? `wss://${location.host}/ws`
  : `ws://${location.host}/ws`;

let ws, roomCode;
let players = {};
let round = 0;
let timerInterval, timerEnd = 0, timerTotal = 1;
let currentSpeeches = [];
let attackOrder = [], currentAttackerIdx = 0;
let cancelData = { cancel:0, ok:0, total:0 };
let ratingData = { submitted:0, total:0 };

function dbg(msg, color) {
  const el = document.getElementById('dbg');
  el.textContent = msg;
  el.style.borderColor = color || '#333';
}

// ‚îÄ‚îÄ CONNECT ‚îÄ‚îÄ
function connect() {
  dbg('üü° –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...', '#e9c46a');
  ws = new WebSocket(WS_URL);
  ws.onopen = () => { dbg('üü¢ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ', '#06d6a0'); ws.send(JSON.stringify({type:'create_room'})); };
  ws.onmessage = e => { try{ handle(JSON.parse(e.data)); }catch(err){ console.error(err); } };
  ws.onerror = () => dbg('üî¥ WebSocket –ø–æ–º–∏–ª–∫–∞', '#e63946');
  ws.onclose = e => { dbg(`üî¥ –ó–∞–∫—Ä–∏—Ç–æ (${e.code}). –ü–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...`, '#e63946'); setTimeout(connect, 3000); };
}

function handle(msg) {
  switch(msg.type) {
    case 'room_created':
      roomCode = msg.code;
      document.getElementById('room-code').textContent = msg.code;
      document.getElementById('join-url').textContent = location.host;
      dbg(`üü¢ –ö—ñ–º–Ω–∞—Ç–∞ ${msg.code} —Å—Ç–≤–æ—Ä–µ–Ω–∞`, '#06d6a0');
      break;

    case 'player_joined': case 'player_left': case 'civ_update':
      updatePlayers(msg.players); break;

    case 'timer':
      startTimerUI(msg.timerEnd, msg.seconds); break;

    case 'round_start':
      round = msg.round;
      document.getElementById('round-num').textContent = round;
      attackOrder = msg.attackOrder || [];
      currentAttackerIdx = 0;
      updatePlayers(msg.players);
      break;

    case 'phase':
      if (msg.players) updatePlayers(msg.players);
      round = msg.round || round;
      document.getElementById('round-num').textContent = round;
      handlePhase(msg);
      break;

    case 'defense_result':
      showDefenseResult(msg); break;

    case 'cancel_vote_update':
      cancelData = { cancel: msg.votes, total: msg.total };
      updateCancelDisplay(); break;

    case 'cancel_result':
      showCancelResult(msg); break;

    case 'rating_update':
      ratingData = { submitted: msg.submitted, total: msg.total };
      updateRatingProgress(); break;

    case 'rating_result':
      updatePlayers(msg.players); break;

    case 'map_update':
      if (window._map) { window._map = msg.map; renderMap(msg.map); }
      break;
  }
}

function handlePhase(msg) {
  showScreen('screen-game');
  switch(msg.phase) {
    case 'civ_select':
      document.getElementById('phase-label').textContent = '–í–∏–±—ñ—Ä —Ü–∏–≤—ñ–ª—ñ–∑–∞—Ü—ñ—ó';
      renderCivSelect(msg.civilizations); break;
    case 'attack_prep':
      currentAttackerIdx = (attackOrder.indexOf(msg.attackerId));
      document.getElementById('phase-label').textContent = `‚öîÔ∏è –ê—Ç–∞–∫–∞ ${msg.attackIndex||''}/${msg.attackTotal||''}`;
      renderAttackPrep(msg); break;
    case 'defense':
      document.getElementById('phase-label').textContent = 'üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç';
      renderDefensePhase(msg); break;
    case 'cancel_vote':
      document.getElementById('phase-label').textContent = 'üö´ –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è Cancel';
      cancelData = { cancel:0, ok:0, total: Object.keys(players).length - 1 };
      renderCancelVote(msg); break;
    case 'rating':
      document.getElementById('phase-label').textContent = '‚≠ê –†–µ–π—Ç–∏–Ω–≥';
      currentSpeeches = msg.speeches || [];
      ratingData = { submitted:0, total: Object.keys(players).length };
      renderRating(msg); break;
    case 'map':
      document.getElementById('phase-label').textContent = 'üó∫Ô∏è –ó–∞—Ö–≤–∞—Ç';
      window._map = msg.map;
      renderMapPhase(msg); break;
    case 'round_end':
      document.getElementById('phase-label').textContent = 'üìä –ü—ñ–¥—Å—É–º–∫–∏';
      renderRoundEnd(msg); break;
  }
}

// ‚îÄ‚îÄ PLAYERS ‚îÄ‚îÄ
function updatePlayers(list) {
  if (!list) return;
  players = {};
  list.forEach(p => players[p.id] = p);

  // Lobby
  const lobby = document.getElementById('lobby-players');
  if (lobby) {
    lobby.innerHTML = list.length === 0
      ? '<div style="color:var(--muted);font-size:.85rem">–û—á—ñ–∫—É—î–º–æ –≥—Ä–∞–≤—Ü—ñ–≤...</div>'
      : list.map(p => `
          <div class="p-chip">
            <div class="p-dot" style="background:${p.color}"></div>
            <div>
              <div class="p-name">${p.civEmoji||'üë§'} ${p.name}</div>
              <div class="p-civ">${p.civName||'–æ–±–∏—Ä–∞—î...'}</div>
            </div>
          </div>`).join('');
  }
  const btn = document.getElementById('btn-start');
  if (btn) btn.disabled = list.length < 2;

  // Scores row
  const sr = document.getElementById('scores-row');
  if (sr) {
    sr.innerHTML = list.map(p => `
      <div class="s-chip">
        <span style="font-size:.9rem">${p.civEmoji||'üë§'}</span>
        <div>
          <div style="font-size:.7rem;font-weight:600">${p.name}</div>
          <div style="font-size:.6rem;color:var(--muted)">${p.civName||''}</div>
        </div>
        <div class="s-score" style="color:${p.color}">${p.score||0}</div>
      </div>`).join('');
  }

  // Attack order sidebar refresh
  refreshOrderPanel();
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function startTimerUI(end, total) {
  clearInterval(timerInterval);
  timerEnd = end; timerTotal = total || 60;
  timerInterval = setInterval(() => {
    const left = Math.max(0, Math.ceil((timerEnd - Date.now()) / 1000));
    document.getElementById('timer-num').textContent = left;
    const pct = (left / timerTotal) * 100;
    const fill = document.getElementById('timer-fill');
    fill.style.width = pct + '%';
    fill.style.background = left < 10 ? 'var(--red)' : 'var(--gold)';
    if (left === 0) clearInterval(timerInterval);
  }, 400);
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ

function renderCivSelect(civs) {
  const lp = document.getElementById('left-panel');
  lp.innerHTML = `<div class="civ-grid" id="civ-grid"></div>`;
  updateCivGrid(civs);
  document.getElementById('right-panel').innerHTML = `
    <div class="card-block">
      <div class="block-label">–ì—Ä–∞–≤—Ü—ñ</div>
      <div id="civ-players-list" style="display:flex;flex-direction:column;gap:.4rem"></div>
    </div>`;
  updateCivPlayersList();
}

function updateCivGrid(civs) {
  const grid = document.getElementById('civ-grid');
  if (!grid || !civs) return;
  grid.innerHTML = civs.map(c => {
    const who = Object.values(players).find(p => p.civId === c.id);
    return `<div class="civ-card ${who?'taken':''}">
      <span class="civ-em">${c.emoji}</span>
      <div class="civ-nm">${c.name}</div>
      <div class="civ-era">${c.era}</div>
      ${who ? `<div class="civ-who">‚úì ${who.name}</div>` : ''}
    </div>`;
  }).join('');
}

function updateCivPlayersList() {
  const el = document.getElementById('civ-players-list');
  if (!el) return;
  el.innerHTML = Object.values(players).map(p => `
    <div style="display:flex;align-items:center;gap:.5rem;font-size:.8rem">
      <div style="width:8px;height:8px;border-radius:50%;background:${p.color}"></div>
      <span>${p.name}</span>
      <span style="margin-left:auto;color:${p.civId?'var(--teal)':'var(--muted)'}">${p.civEmoji||'‚è≥'} ${p.civName||'–æ–±–∏—Ä–∞—î...'}</span>
    </div>`).join('');
}

function renderAttackPrep(msg) {
  const attacker = players[msg.attackerId];
  const lp = document.getElementById('left-panel');
  lp.innerHTML = `
    <div class="card-block">
      <div class="block-label">‚öîÔ∏è –ê—Ç–∞–∫—É—é—á–∏–π</div>
      <div style="display:flex;align-items:center;gap:1rem;margin-top:.25rem">
        <span style="font-size:3rem">${attacker?.civEmoji||'‚öîÔ∏è'}</span>
        <div>
          <div class="block-title">${attacker?.name||'?'}</div>
          <div class="civ-badge">${attacker?.civName||''}</div>
        </div>
      </div>
    </div>
    <div class="big-center" style="flex:1">
      <div class="big-icon">‚è≥</div>
      <div>–ì—Ä–∞–≤–µ—Ü—å –æ–±–∏—Ä–∞—î —Ü—ñ–ª—å —ñ –∞—Ä–≥—É–º–µ–Ω—Ç–∏</div>
      <div style="font-size:.8rem;color:var(--muted)">–ø–æ—Ç—ñ–º –≤–∏—Å—Ç—É–ø–∏—Ç—å –≤–≥–æ–ª–æ—Å</div>
    </div>`;
  refreshOrderPanel();
}

function refreshOrderPanel() {
  const rp = document.getElementById('right-panel');
  if (!rp || !attackOrder.length) return;
  rp.innerHTML = `
    <div class="card-block">
      <div class="block-label">–ü–æ—Ä—è–¥–æ–∫ –∞—Ç–∞–∫</div>
      <div class="order-list" style="margin-top:.25rem">
        ${attackOrder.map((pid, i) => {
          const p = players[pid];
          const cls = i < currentAttackerIdx ? 'done' : i === currentAttackerIdx ? 'current' : '';
          return `<div class="order-item ${cls}">
            <div class="order-idx">${i+1}</div>
            <span>${p?.civEmoji||'üë§'}</span>
            <span>${p?.name||pid}</span>
            ${i === currentAttackerIdx ? '<span style="margin-left:auto;color:var(--red);font-size:.7rem">‚ñ∂ –∑–∞—Ä–∞–∑</span>' : ''}
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

function renderDefensePhase(msg) {
  const attacker = players[msg.attackerId];
  const defender = players[msg.defenderId];
  const lp = document.getElementById('left-panel');

  lp.innerHTML = `
    <div class="card-block">
      <div style="display:flex;gap:1rem;align-items:flex-start">
        <div style="flex:1">
          <div class="block-label">‚öîÔ∏è –ê—Ç–∞–∫–∞</div>
          <div style="display:flex;align-items:center;gap:.75rem;margin:.3rem 0">
            <span style="font-size:2rem">${attacker?.civEmoji||'‚öîÔ∏è'}</span>
            <div>
              <div style="font-weight:700">${attacker?.name||'?'}</div>
              <div class="civ-badge">${attacker?.civName||''}</div>
            </div>
          </div>
          ${msg.usedFallacy ? `<div class="fallacy-pill">üÉè ${msg.usedFallacy.name}</div>` : ''}
        </div>
        <div style="font-size:2rem;align-self:center">‚Üí</div>
        <div style="flex:1">
          <div class="block-label" style="color:var(--teal)">üõ°Ô∏è –ó–∞—Ö–∏—Å—Ç</div>
          <div style="display:flex;align-items:center;gap:.75rem;margin:.3rem 0">
            <span style="font-size:2rem">${defender?.civEmoji||'üõ°Ô∏è'}</span>
            <div>
              <div style="font-weight:700" id="def-name">${defender?.name||'?'}</div>
              <div class="civ-badge">${defender?.civName||''}</div>
            </div>
          </div>
          <div id="def-status" style="font-size:.8rem;color:var(--muted)">–û—á—ñ–∫—É—î–º–æ —Ä—ñ—à–µ–Ω–Ω—è...</div>
        </div>
      </div>
    </div>
    ${msg.fact ? `
      <div class="fact-box" style="flex:1;overflow-y:auto">
        <div class="fact-title">üìú ${msg.fact.title}</div>
        <div class="fact-body">${msg.fact.body}</div>
        <div class="fact-angle-atk">${msg.fact.attacker_angle}</div>
      </div>` : ''}`;

  refreshOrderPanel();
}

function showDefenseResult(msg) {
  const el = document.getElementById('def-status');
  if (!el) return;
  if (msg.choice === 'silence') {
    el.innerHTML = '<span style="color:var(--muted)">ü§ê –ü—Ä–æ–º–æ–≤—á–∞–≤ (-1 –±–∞–ª)</span>';
  } else {
    el.innerHTML = '<span style="color:var(--teal)">üó£Ô∏è –ó–∞—Ö–∏—â–∞—î—Ç—å—Å—è! ‚Üí –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è...</span>';
  }
}

function renderCancelVote(msg) {
  const defender = players[msg.defenderId];
  const lp = document.getElementById('left-panel');
  lp.innerHTML = `
    <div class="card-block" style="flex:1;align-items:center;justify-content:center">
      <div class="cancel-center">
        <div style="font-size:3.5rem">${defender?.civEmoji||'üõ°Ô∏è'}</div>
        <div style="font-family:'Unbounded',sans-serif;font-size:1.2rem;margin:.5rem 0">
          ${defender?.name||'?'} ‚Äî ${defender?.civName||''}
        </div>
        <div style="font-size:.85rem;color:var(--muted)">–ß–∏ –ø–µ—Ä–µ–∫–æ–Ω–ª–∏–≤–∏–π –∑–∞—Ö–∏—Å—Ç?</div>
        <div class="cancel-count" id="cancel-count">?</div>
        <div style="font-size:.8rem;color:var(--muted)">Cancel –≥–æ–ª–æ—Å—ñ–≤ / <span id="cancel-total">${cancelData.total}</span></div>
        <div id="cancel-result-msg" style="margin-top:1rem;font-family:'Unbounded',sans-serif;font-size:.9rem"></div>
      </div>
    </div>`;
  document.getElementById('right-panel').innerHTML = `
    <div class="card-block">
      <div class="block-label">–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤</div>
      <div id="cancel-votes-list" style="display:flex;flex-direction:column;gap:.3rem;margin-top:.25rem"></div>
    </div>`;
}

function updateCancelDisplay() {
  const el = document.getElementById('cancel-count');
  if (el) el.textContent = cancelData.cancel;
  const vl = document.getElementById('cancel-votes-list');
  if (vl) {
    vl.innerHTML = `
      <div class="vote-bar red">üö´ Cancel: ${cancelData.cancel}</div>
      <div class="vote-bar green">‚úÖ OK: ${cancelData.total - cancelData.cancel}</div>`;
  }
}

function showCancelResult(msg) {
  const el = document.getElementById('cancel-result-msg');
  if (el) {
    el.style.color = msg.cancelled ? 'var(--red)' : 'var(--teal)';
    el.textContent = msg.cancelled
      ? `‚úó CANCELLED ‚Äî ${msg.cancelCount}/${msg.totalVoters} –≥–æ–ª–æ—Å—ñ–≤ (-4)`
      : `‚úì –ü–†–ò–ô–ù–Ø–¢–û ‚Äî ${msg.cancelCount}/${msg.totalVoters} cancel (+3)`;
  }
  if (document.getElementById('cancel-count'))
    document.getElementById('cancel-count').textContent = msg.cancelCount;
}

function renderRating(msg) {
  const lp = document.getElementById('left-panel');
  lp.innerHTML = `
    <div class="card-block" style="flex:1;overflow:hidden;display:flex;flex-direction:column;gap:.75rem">
      <div class="block-label">‚≠ê –í–∏—Å—Ç—É–ø–∏ —Ä–∞—É–Ω–¥—É ‚Äî –≥—Ä–∞–≤—Ü—ñ –≥–æ–ª–æ—Å—É—é—Ç—å</div>
      <div class="speeches-list">
        ${(msg.speeches||[]).map(s => `
          <div class="speech-row">
            <span style="font-size:1.2rem">${s.civEmoji||'üë§'}</span>
            <div style="flex:1">
              <div style="font-weight:600;font-size:.85rem">${s.playerName} <span style="color:var(--muted);font-size:.7rem">${s.civName||''}</span></div>
              ${s.fallacyName ? `<div style="font-size:.7rem;color:var(--muted)">üÉè ${s.fallacyName}</div>` : ''}
              ${s.factTitle ? `<div style="font-size:.7rem;color:var(--muted)">üìú ${s.factTitle}</div>` : ''}
            </div>
            <span class="speech-role ${s.role==='attack'?'atk':'def'}">${s.role==='attack'?'–ê—Ç–∞–∫–∞':'–ó–∞—Ö–∏—Å—Ç'}</span>
          </div>`).join('')}
        ${(msg.speeches||[]).length===0 ? '<div style="color:var(--muted);font-size:.8rem;text-align:center;padding:1rem">–í–∏—Å—Ç—É–ø—ñ–≤ –Ω–µ –±—É–ª–æ</div>' : ''}
      </div>
      <div style="font-size:.8rem;color:var(--muted);text-align:center" id="rating-progress">
        –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: 0 / ${Object.keys(players).length}
      </div>
    </div>`;
}

function updateRatingProgress() {
  const el = document.getElementById('rating-progress');
  if (el) el.textContent = `–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: ${ratingData.submitted} / ${ratingData.total}`;
}

function renderMapPhase(msg) {
  const lp = document.getElementById('left-panel');
  lp.innerHTML = `<svg id="host-hex-svg" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg" style="flex:1;width:100%"></svg>`;
  const rp = document.getElementById('right-panel');
  rp.innerHTML = `
    <div class="card-block">
      <div class="block-label">–ó–∞—Ö–≤–∞—Ç</div>
      <div class="map-legend" id="map-legend"></div>
    </div>`;
  renderMap(msg.map);
  renderMapLegend(msg.players||Object.values(players));
}

function hexPts(cx, cy, r) {
  return Array.from({length:6},(_,i)=>{
    const a=Math.PI/180*(60*i-30);
    return `${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`;
  }).join(' ');
}

function renderMap(map) {
  const svg = document.getElementById('host-hex-svg');
  if (!svg || !map) return;
  const R=16, W=R*Math.sqrt(3), PAD=R;
  const G=map.grid, W2=G*W+PAD*2, H2=G*R*2*0.75+R*0.5+PAD*2;
  svg.setAttribute('viewBox',`0 0 ${W2} ${H2}`);
  svg.innerHTML = map.cells.map(cell => {
    const cx=PAD+cell.col*W+(cell.row%2===1?W/2:0)+W/2;
    const cy=PAD+cell.row*R*2*0.75+R;
    const owner=cell.owner?players[cell.owner]:null;
    const fill=owner?owner.color:'#0f0f1a';
    return `<polygon points="${hexPts(cx,cy,R-1)}" fill="${fill}" stroke="#0a0a0f" stroke-width="0.8"/>`;
  }).join('');
}

function renderMapLegend(plist) {
  const el = document.getElementById('map-legend');
  if (!el) return;
  el.innerHTML = (plist||[]).map(p => `
    <div class="leg-item">
      <div class="leg-dot" style="background:${p.color}"></div>
      <span style="font-size:.9rem">${p.civEmoji||'üë§'}</span>
      <div>
        <div style="font-weight:600">${p.name}</div>
        <div style="font-size:.65rem;color:var(--muted)">${p.civName||''} ¬∑ ${p.score||0} –±–∞–ª—ñ–≤</div>
      </div>
    </div>`).join('');
}

function renderRoundEnd(msg) {
  const sorted = [...(msg.players||Object.values(players))].sort((a,b)=>b.score-a.score);
  const lp = document.getElementById('left-panel');
  lp.innerHTML = `
    <div class="block-label" style="font-size:.7rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted)">
      –ü—ñ–¥—Å—É–º–∫–∏ —Ä–∞—É–Ω–¥—É ${round}
    </div>
    <div class="podium">
      ${sorted.map((p,i)=>`
        <div class="podium-card">
          <div class="podium-rank" style="color:${i===0?'var(--gold)':i===1?'#aaa':'var(--muted)'}">#${i+1}</div>
          <span style="font-size:2rem">${p.civEmoji||'üë§'}</span>
          <div>
            <div style="font-weight:700">${p.name}</div>
            <div style="font-size:.7rem;color:var(--muted)">${p.civName||''}</div>
          </div>
          <div class="podium-pts" style="color:${p.color}">${p.score}</div>
        </div>`).join('')}
    </div>`;

  const rp = document.getElementById('right-panel');
  if (msg.map) {
    rp.innerHTML = `<svg id="host-hex-svg" viewBox="0 0 0 0" style="width:100%;flex:1"></svg>`;
    window._map = msg.map; renderMap(msg.map);
  }
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function startGame() { ws.send(JSON.stringify({type:'start_game'})); }
function nextPhase() { ws.send(JSON.stringify({type:'next_phase'})); }

connect();
</script>
</body>
</html>