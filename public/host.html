<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FallacyMania — Ведучий</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Unbounded:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #1e1e2e;
    --accent: #ff3c5f;
    --gold: #ffd166;
    --teal: #06d6a0;
    --blue: #118ab2;
    --text: #e8e8f0;
    --muted: #6b6b80;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── NOISE TEXTURE ── */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 9999;
  }

  /* ── LOBBY ── */
  #screen-lobby {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    gap: 2rem;
    padding: 2rem;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(4rem, 10vw, 9rem);
    letter-spacing: 0.05em;
    background: linear-gradient(135deg, #ff3c5f, #ffd166, #06d6a0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
  }

  .room-code-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .room-code-label {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .room-code {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(5rem, 15vw, 12rem);
    letter-spacing: 0.2em;
    color: var(--gold);
    text-shadow: 0 0 60px rgba(255,209,102,0.4);
  }

  .join-url {
    font-family: 'Inter', sans-serif;
    font-size: 1.1rem;
    color: var(--muted);
    background: var(--surface);
    padding: 0.75rem 2rem;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  .join-url span { color: var(--teal); }

  .players-lobby {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    max-width: 800px;
  }

  .player-chip {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 0.6rem 1.2rem;
    font-family: 'Unbounded', sans-serif;
    font-size: 0.85rem;
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes popIn {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .player-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
  }

  .btn-start {
    background: var(--accent);
    color: white;
    border: none;
    font-family: 'Unbounded', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    padding: 1rem 3rem;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: all 0.2s;
    box-shadow: 0 0 30px rgba(255, 60, 95, 0.4);
  }

  .btn-start:hover { transform: translateY(-2px); box-shadow: 0 0 50px rgba(255, 60, 95, 0.6); }
  .btn-start:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* ── PHASE SCREENS ── */
  .screen { display: none; padding: 2rem; min-height: 100vh; }
  .screen.active { display: flex; flex-direction: column; }

  .phase-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .phase-label {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .phase-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3rem;
    letter-spacing: 0.05em;
    color: var(--gold);
  }

  .round-badge {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.4rem 1.2rem;
    border-radius: 6px;
    color: var(--muted);
    letter-spacing: 0.1em;
  }

  /* ── TIMER BAR ── */
  .timer-bar-wrap {
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    margin-bottom: 2rem;
    overflow: hidden;
  }
  .timer-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--teal), var(--accent));
    transition: width 1s linear;
    border-radius: 4px;
  }

  /* ── TOPIC SELECT PHASE ── */
  .topics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    flex: 1;
    align-content: center;
  }

  .topic-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    font-family: 'Unbounded', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    line-height: 1.4;
    position: relative;
  }

  .topic-card .topic-num {
    position: absolute;
    top: 1rem; left: 1rem;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--accent);
  }

  /* ── SPEECH PHASE ── */
  .speech-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    flex: 1;
  }

  .player-speech-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .player-speech-name {
    font-family: 'Unbounded', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .player-speech-topic {
    font-size: 0.9rem;
    color: var(--muted);
    font-style: italic;
  }

  .btn-next {
    align-self: flex-end;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    font-family: 'Unbounded', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    cursor: pointer;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    transition: all 0.2s;
    margin-top: 1rem;
  }
  .btn-next:hover { background: var(--accent); border-color: var(--accent); }

  /* ── VOTE PHASE ── */
  .vote-layout {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    flex: 1;
    justify-content: center;
  }

  .vote-status {
    font-family: 'Unbounded', sans-serif;
    font-size: 1rem;
    color: var(--muted);
  }

  .vote-bars {
    display: flex;
    gap: 1.5rem;
    align-items: flex-end;
    height: 200px;
  }

  .vote-bar-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    width: 80px;
  }

  .vote-bar-fill {
    width: 60px;
    background: var(--accent);
    border-radius: 6px 6px 0 0;
    transition: height 0.5s ease;
    min-height: 4px;
  }

  .vote-bar-name {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.65rem;
    text-align: center;
    color: var(--muted);
  }

  .vote-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
  }

  /* ── MAP PHASE ── */
  #screen-map {
    display: none;
    flex-direction: row;
    gap: 2rem;
  }
  #screen-map.active { display: flex; }

  .map-area {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .map-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    flex: 1;
    align-content: center;
  }

  .map-cell {
    aspect-ratio: 1;
    border-radius: 6px;
    border: 2px solid rgba(255,255,255,0.05);
    transition: all 0.3s;
    cursor: default;
    position: relative;
  }

  .map-cell.neutral { background: var(--border); }
  .map-cell.capture-anim { animation: captureFlash 0.5s ease; }

  @keyframes captureFlash {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); filter: brightness(1.5); }
    100% { transform: scale(1); }
  }

  .scores-sidebar {
    width: 260px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .score-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.2rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .score-card-dot {
    width: 16px; height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .score-card-info { flex: 1; }

  .score-card-name {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.8rem;
    font-weight: 700;
  }

  .score-card-pts {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    color: var(--gold);
    letter-spacing: 0.05em;
  }

  .score-card-territories {
    font-size: 0.7rem;
    color: var(--muted);
    font-family: 'Inter', sans-serif;
  }

  /* ── RESULTS ── */
  #screen-round-end { justify-content: center; align-items: center; gap: 2rem; }

  .results-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 4rem;
    color: var(--gold);
    text-align: center;
  }

  .results-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 500px;
  }

  .result-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.5rem;
    animation: slideIn 0.4s ease both;
  }

  @keyframes slideIn {
    from { transform: translateX(-30px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .result-rank {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--muted);
    width: 2rem;
    text-align: center;
  }
  .result-rank.first { color: var(--gold); }

  .result-name {
    flex: 1;
    font-family: 'Unbounded', sans-serif;
    font-size: 0.9rem;
  }

  .result-score {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--teal);
    letter-spacing: 0.05em;
  }
</style>
</head>
<body>

<!-- LOBBY -->
<div id="screen-lobby">
  <div class="logo">FallacyMania</div>
  <div class="room-code-display">
    <div class="room-code-label">Код кімнати</div>
    <div class="room-code" id="room-code">—</div>
  </div>
  <div class="join-url">Зайдіть на <span id="join-url-text">...</span> та введіть код</div>
  <div class="players-lobby" id="players-lobby"></div>
  <button class="btn-start" id="btn-start" disabled onclick="startGame()">Почати гру</button>
</div>

<!-- TOPIC SELECT -->
<div id="screen-topic" class="screen">
  <div class="phase-header">
    <div>
      <div class="phase-label">Фаза 1</div>
      <div class="phase-title">Вибір теми</div>
    </div>
    <div class="round-badge" id="round-badge-topic">Раунд 1</div>
  </div>
  <div class="timer-bar-wrap"><div class="timer-bar" id="timer-topic" style="width:100%"></div></div>
  <div class="topics-grid" id="topics-grid"></div>
</div>

<!-- FALLACY DEAL -->
<div id="screen-fallacy" class="screen">
  <div class="phase-header">
    <div>
      <div class="phase-label">Фаза 2</div>
      <div class="phase-title">Картки на руках</div>
    </div>
    <div class="round-badge" id="round-badge-fallacy">Раунд 1</div>
  </div>
  <div class="timer-bar-wrap"><div class="timer-bar" id="timer-fallacy" style="width:100%"></div></div>
  <div style="flex:1; display:flex; align-items:center; justify-content:center; text-align:center;">
    <div>
      <div style="font-family:'Bebas Neue',sans-serif; font-size:4rem; color:var(--muted);">Гравці вивчають картки</div>
      <div style="font-size:1rem; color:var(--muted); margin-top:1rem;">Підготуйте свої промови!</div>
    </div>
  </div>
  <button class="btn-next" onclick="nextPhase()">▶ Починаємо промови</button>
</div>

<!-- SPEECH -->
<div id="screen-speech" class="screen">
  <div class="phase-header">
    <div>
      <div class="phase-label">Фаза 3</div>
      <div class="phase-title">Промови</div>
    </div>
    <div class="round-badge" id="round-badge-speech">Раунд 1</div>
  </div>
  <div class="speech-layout" id="speech-layout"></div>
  <button class="btn-next" onclick="nextPhase()">▶ Голосування</button>
</div>

<!-- VOTE -->
<div id="screen-vote" class="screen">
  <div class="phase-header">
    <div>
      <div class="phase-label">Фаза 4</div>
      <div class="phase-title">Голосування</div>
    </div>
    <div class="round-badge" id="round-badge-vote">Раунд 1</div>
  </div>
  <div class="timer-bar-wrap"><div class="timer-bar" id="timer-vote" style="width:100%"></div></div>
  <div class="vote-layout">
    <div class="vote-status" id="vote-status">Чекаємо на голоси...</div>
    <div class="vote-bars" id="vote-bars"></div>
  </div>
</div>

<!-- MAP -->
<div id="screen-map" class="screen">
  <div class="map-area">
    <div class="phase-header">
      <div>
        <div class="phase-label">Фаза 5</div>
        <div class="phase-title">Карта світу</div>
      </div>
      <div class="round-badge" id="round-badge-map">Раунд 1</div>
    </div>
    <div class="timer-bar-wrap"><div class="timer-bar" id="timer-map" style="width:100%"></div></div>
    <div class="map-grid" id="map-grid"></div>
  </div>
  <div class="scores-sidebar" id="scores-sidebar"></div>
</div>

<!-- ROUND END -->
<div id="screen-round-end" class="screen">
  <div class="results-title" id="results-title">Раунд завершено!</div>
  <div class="results-list" id="results-list"></div>
  <button class="btn-next" onclick="nextPhase()">▶ Наступний раунд</button>
</div>

<script>
const WS_URL = location.protocol === 'https:'
  ? `wss://${location.host}/ws`
  : `ws://${location.host}/ws`;

let ws, roomCode, players = {}, map = null, timerInterval = null;

// ── CONNECT ──────────────────────────────────────────────────────────────────
function setStatus(msg, color) {
  let el = document.getElementById("debug-status");
  if (!el) {
    el = document.createElement("div");
    el.id = "debug-status";
    el.style.cssText = "position:fixed;bottom:1rem;left:1rem;background:#111;color:#fff;padding:.5rem 1rem;border-radius:8px;font-size:.8rem;font-family:monospace;z-index:9999;border:1px solid #333;max-width:600px;word-break:break-all";
    document.body.appendChild(el);
  }
  el.style.borderColor = color || "#333";
  el.textContent = msg;
}

function connect() {
  setStatus("Підключення до " + WS_URL + "...", "#ffd166");
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    setStatus("✓ WebSocket підключено", "#06d6a0");
    ws.send(JSON.stringify({ type: "create_room" }));
  };
  ws.onmessage = e => {
    try { handle(JSON.parse(e.data)); }
    catch(err) { setStatus("Помилка парсингу: " + err.message, "#ff3c5f"); }
  };
  ws.onerror = () => setStatus("✗ WebSocket помилка — перевір консоль F12", "#ff3c5f");
  ws.onclose = (e) => {
    setStatus("✗ З'єднання закрито (код " + e.code + "). Перепідключення...", "#ff3c5f");
    setTimeout(connect, 3000);
  };
}

// ── HANDLE MESSAGES ───────────────────────────────────────────────────────────
function handle(msg) {
  switch(msg.type) {
    case 'room_created':
      roomCode = msg.code;
      document.getElementById('room-code').textContent = msg.code;
      document.getElementById('join-url-text').textContent = `${location.host}/player.html`;
      break;

    case 'player_joined':
    case 'player_left':
      updatePlayers(msg.players);
      break;

    case 'phase':
      handlePhase(msg);
      break;

    case 'timer':
      startTimerBar(msg.timerEnd);
      break;

    case 'vote_result':
      showVoteResult(msg);
      break;

    case 'map_update':
      map = msg.map;
      renderMap();
      break;
  }
}

function updatePlayers(list) {
  players = {};
  list.forEach(p => players[p.id] = p);
  renderLobbyPlayers(list);
  document.getElementById('btn-start').disabled = list.length < 2;
}

function renderLobbyPlayers(list) {
  const el = document.getElementById('players-lobby');
  el.innerHTML = list.map(p => `
    <div class="player-chip">
      <div class="player-dot" style="background:${p.color}"></div>
      ${p.name}
    </div>
  `).join('');
}

// ── PHASE HANDLING ────────────────────────────────────────────────────────────
function showScreen(id) {
  document.querySelectorAll('.screen, #screen-lobby').forEach(el => {
    el.classList.remove('active');
    if (el.id !== 'screen-lobby') el.style.display = 'none';
    else el.style.display = 'none';
  });
  const target = document.getElementById(id);
  if (target) {
    target.style.display = 'flex';
    target.classList.add('active');
  }
}

function handlePhase(msg) {
  const round = msg.round || 1;

  if (msg.phase === 'topic_select') {
    showScreen('screen-topic');
    document.getElementById('round-badge-topic').textContent = `Раунд ${round}`;
    renderTopics(msg.topics || []);
  }
  if (msg.phase === 'fallacy_deal') {
    showScreen('screen-fallacy');
    document.getElementById('round-badge-fallacy').textContent = `Раунд ${round}`;
  }
  if (msg.phase === 'speech') {
    showScreen('screen-speech');
    document.getElementById('round-badge-speech').textContent = `Раунд ${round}`;
    renderSpeeches(msg.playerTopics || {});
  }
  if (msg.phase === 'vote') {
    showScreen('screen-vote');
    document.getElementById('round-badge-vote').textContent = `Раунд ${round}`;
    renderVoteBars();
  }
  if (msg.phase === 'map') {
    showScreen('screen-map');
    document.getElementById('round-badge-map').textContent = `Раунд ${round}`;
    if (msg.map) map = msg.map;
    renderMap();
    renderScoresSidebar(msg.players || [], msg.roundScores || {});
  }
  if (msg.phase === 'round_end') {
    showScreen('screen-round-end');
    renderRoundEnd(msg.players || []);
    if (msg.map) { map = msg.map; }
  }
}

// ── RENDER TOPICS ─────────────────────────────────────────────────────────────
function renderTopics(topics) {
  const grid = document.getElementById('topics-grid');
  grid.innerHTML = topics.map((t, i) => `
    <div class="topic-card">
      <div class="topic-num">${i + 1}</div>
      ${t}
    </div>
  `).join('');
}

// ── RENDER SPEECHES ───────────────────────────────────────────────────────────
function renderSpeeches(playerTopics) {
  const layout = document.getElementById('speech-layout');
  layout.innerHTML = Object.entries(playerTopics).map(([pid, topic]) => {
    const p = players[pid];
    if (!p) return '';
    return `
      <div class="player-speech-card">
        <div class="player-speech-name">
          <div class="player-dot" style="background:${p.color}"></div>
          ${p.name}
        </div>
        <div class="player-speech-topic">"${topic}"</div>
      </div>
    `;
  }).join('');
}

// ── RENDER VOTE BARS ──────────────────────────────────────────────────────────
let currentVoteTally = {};
function renderVoteBars(tally = {}) {
  currentVoteTally = tally;
  const maxV = Math.max(1, ...Object.values(tally));
  const el = document.getElementById('vote-bars');
  el.innerHTML = Object.values(players).map(p => {
    const v = tally[p.id] || 0;
    const h = Math.max(4, (v / maxV) * 160);
    return `
      <div class="vote-bar-item">
        <div class="vote-count" style="color:${p.color}">${v}</div>
        <div class="vote-bar-fill" style="height:${h}px; background:${p.color}"></div>
        <div class="vote-bar-name">${p.name}</div>
      </div>
    `;
  }).join('');
}

function showVoteResult(msg) {
  renderVoteBars(msg.tally || {});
}

// ── RENDER MAP ────────────────────────────────────────────────────────────────
function renderMap() {
  if (!map) return;
  const grid = document.getElementById('map-grid');
  grid.innerHTML = map.cells.map(cell => {
    const owner = cell.owner ? players[cell.owner] : null;
    const bg = owner ? owner.color : 'var(--border)';
    return `<div class="map-cell" style="background:${bg}" data-id="${cell.id}"></div>`;
  }).join('');
}

function renderScoresSidebar(playerList, roundScores) {
  const el = document.getElementById('scores-sidebar');
  el.innerHTML = playerList.map(p => {
    const territories = map ? map.cells.filter(c => c.owner === p.id).length : 0;
    return `
      <div class="score-card">
        <div class="score-card-dot" style="background:${p.color}"></div>
        <div class="score-card-info">
          <div class="score-card-name">${p.name}</div>
          <div class="score-card-territories">${territories} тер. · +${roundScores[p.id] || 0} очок</div>
        </div>
        <div class="score-card-pts">${p.score}</div>
      </div>
    `;
  }).join('');
}

// ── ROUND END ────────────────────────────────────────────────────────────────
function renderRoundEnd(playerList) {
  const sorted = [...playerList].sort((a, b) => b.score - a.score);
  const el = document.getElementById('results-list');
  el.innerHTML = sorted.map((p, i) => `
    <div class="result-item" style="animation-delay:${i * 0.1}s">
      <div class="result-rank ${i === 0 ? 'first' : ''}">${i + 1}</div>
      <div class="player-dot" style="background:${p.color}; width:14px;height:14px;border-radius:50%;flex-shrink:0"></div>
      <div class="result-name">${p.name}</div>
      <div class="result-score">${p.score} очк</div>
    </div>
  `).join('');
}

// ── TIMER BAR ─────────────────────────────────────────────────────────────────
function startTimerBar(endTime) {
  clearInterval(timerInterval);
  const bars = document.querySelectorAll('.timer-bar');
  timerInterval = setInterval(() => {
    const remaining = endTime - Date.now();
    const total = endTime - (endTime - remaining); // rough
    bars.forEach(bar => {
      const pct = Math.max(0, remaining / 30000 * 100);
      bar.style.width = pct + '%';
    });
    if (remaining <= 0) clearInterval(timerInterval);
  }, 100);
}

// ── ACTIONS ───────────────────────────────────────────────────────────────────
function startGame() {
  ws.send(JSON.stringify({ type: 'start_game' }));
}

function nextPhase() {
  ws.send(JSON.stringify({ type: 'next_phase' }));
}

// ── INIT ──────────────────────────────────────────────────────────────────────
connect();
</script>
</body>
</html>