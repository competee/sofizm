<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FallacyMania â€” Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Unbounded:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0a0a0f;--surface:#13131a;--border:#1e1e2e;
    --text:#e8e8f0;--muted:#6b6b80;
    --red:#e63946;--teal:#2a9d8f;--gold:#e9c46a;--blue:#457b9d;
  }
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;overflow:hidden}
  body{display:flex;flex-direction:column}

  .screen{display:none;flex:1;flex-direction:column;padding:1.25rem;gap:.75rem;overflow-y:auto;overflow-x:hidden}
  .screen.active{display:flex}

  /* â”€â”€ JOIN â”€â”€ */
  .join-logo{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;text-align:center;
    background:linear-gradient(135deg,#ff3c5f,#ffd166,#06d6a0);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.5rem}
  .input-field{background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:.9rem 1.1rem;font-size:1rem;color:var(--text);width:100%;outline:none;
    font-family:'Inter',sans-serif;transition:border-color .2s}
  .input-field:focus{border-color:var(--gold)}
  .btn-join{background:var(--red);color:#fff;border:none;padding:1rem;
    font-family:'Unbounded',sans-serif;font-size:.85rem;font-weight:700;
    border-radius:12px;cursor:pointer;width:100%;margin-top:.25rem;transition:opacity .2s}
  .btn-join:hover{opacity:.85}
  .error-msg{color:var(--red);font-size:.8rem;text-align:center;min-height:1.2rem}

  /* â”€â”€ PHASE HEADER â”€â”€ */
  .phase-header{padding:.5rem 0;border-bottom:1px solid var(--border);flex-shrink:0}
  .phase-tag{font-family:'Unbounded',sans-serif;font-size:.6rem;letter-spacing:.15em;
    text-transform:uppercase;color:var(--muted)}
  .phase-h{font-family:'Unbounded',sans-serif;font-size:1.1rem;font-weight:900;margin-top:.2rem}
  .my-civ-bar{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;
    background:var(--surface);border-radius:10px;margin-top:.5rem;font-size:.85rem}

  /* â”€â”€ WAITING â”€â”€ */
  .waiting-center{flex:1;display:flex;flex-direction:column;align-items:center;
    justify-content:center;gap:1rem;text-align:center}
  .waiting-emoji{font-size:4rem}
  .waiting-text{font-family:'Unbounded',sans-serif;font-size:.9rem}
  .waiting-sub{font-size:.8rem;color:var(--muted)}
  .pulse{animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

  /* â”€â”€ CIV SELECT â”€â”€ */
  .civ-list{display:flex;flex-direction:column;gap:.6rem;flex:1;overflow-y:auto}
  .civ-btn{background:var(--surface);border:2px solid var(--border);border-radius:14px;
    padding:1rem;display:flex;align-items:center;gap:.9rem;cursor:pointer;
    transition:all .2s;text-align:left;width:100%}
  .civ-btn:hover:not(:disabled){border-color:var(--gold)}
  .civ-btn.selected{border-color:var(--teal);background:#2a9d8f15}
  .civ-btn:disabled{opacity:.45;cursor:default}
  .civ-btn-emoji{font-size:2rem;flex-shrink:0}
  .civ-btn-name{font-family:'Unbounded',sans-serif;font-size:.8rem;font-weight:700}
  .civ-btn-desc{font-size:.7rem;color:var(--muted);margin-top:.2rem;line-height:1.4}
  .civ-taken{font-size:.65rem;color:var(--red);margin-top:.2rem}

  /* â”€â”€ ATTACK TURN â”€â”€ */
  .section-label{font-size:.65rem;letter-spacing:.15em;text-transform:uppercase;
    color:var(--muted);font-weight:600;margin-bottom:.4rem}
  .target-list{display:flex;flex-direction:column;gap:.5rem}
  .target-btn{background:var(--surface);border:2px solid var(--border);border-radius:12px;
    padding:.8rem 1rem;display:flex;align-items:center;gap:.75rem;cursor:pointer;transition:all .2s;width:100%}
  .target-btn.selected{border-color:var(--red)}
  .target-btn-civ{font-size:1.5rem}

  .fact-list{display:flex;flex-direction:column;gap:.5rem;overflow-y:auto;max-height:200px}
  .fact-btn{background:var(--surface);border:2px solid var(--border);border-radius:10px;
    padding:.75rem;cursor:pointer;transition:all .2s;text-align:left;width:100%}
  .fact-btn.selected{border-color:var(--gold)}
  .fact-btn-title{font-size:.8rem;font-weight:600;color:var(--gold)}
  .fact-btn-type{font-size:.65rem;color:var(--muted);margin-top:.2rem}

  .fallacy-mini-list{display:flex;flex-direction:column;gap:.4rem}
  .fallacy-mini{background:var(--surface);border:2px solid var(--border);border-radius:10px;
    padding:.6rem .8rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:.6rem}
  .fallacy-mini.selected{border-color:var(--red)}
  .fallacy-mini-name{font-size:.8rem;font-weight:600}
  .fallacy-mini-tag{font-size:.6rem;padding:.15rem .5rem;border-radius:100px;background:var(--border)}

  .btn-confirm{background:var(--red);color:#fff;border:none;padding:.9rem;
    font-family:'Unbounded',sans-serif;font-size:.8rem;font-weight:700;
    border-radius:12px;cursor:pointer;width:100%;transition:opacity .2s;margin-top:.5rem}
  .btn-confirm:hover{opacity:.85}
  .btn-confirm:disabled{opacity:.35;cursor:default}

  /* â”€â”€ DEFENSE â”€â”€ */
  .fact-display{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem}
  .fact-display-title{font-family:'Unbounded',sans-serif;font-size:.85rem;font-weight:700;color:var(--gold);margin-bottom:.5rem}
  .fact-display-body{font-size:.78rem;color:var(--muted);line-height:1.6}
  .attacker-angle{font-size:.78rem;color:var(--red);border-left:2px solid var(--red);
    padding-left:.75rem;margin-top:.75rem;font-style:italic;line-height:1.5}
  .defender-angle{font-size:.78rem;color:var(--teal);border-left:2px solid var(--teal);
    padding-left:.75rem;margin-top:.5rem;font-style:italic;line-height:1.5}

  .defense-actions{display:flex;flex-direction:column;gap:.6rem;margin-top:.5rem}
  .btn-speak{background:var(--teal);color:#fff;border:none;padding:.9rem;
    font-family:'Unbounded',sans-serif;font-size:.8rem;font-weight:700;
    border-radius:12px;cursor:pointer;width:100%}
  .btn-silence{background:transparent;color:var(--muted);border:1px solid var(--border);
    padding:.75rem;font-size:.8rem;border-radius:12px;cursor:pointer;width:100%}

  /* â”€â”€ CANCEL VOTE â”€â”€ */
  .cancel-btns{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:1rem}
  .btn-cancel-vote{padding:1.5rem;border:2px solid;border-radius:14px;
    font-family:'Unbounded',sans-serif;font-size:.85rem;font-weight:700;
    cursor:pointer;transition:all .2s;font-size:1.5rem}
  .btn-cancel-vote.red{border-color:var(--red);color:var(--red);background:#e6394611}
  .btn-cancel-vote.green{border-color:var(--teal);color:var(--teal);background:#2a9d8f11}
  .btn-cancel-vote:hover{opacity:.8}
  .btn-cancel-vote:disabled{opacity:.3;cursor:default}

  /* â”€â”€ RATING â”€â”€ */
  .rating-list{display:flex;flex-direction:column;gap:.5rem;flex:1}
  .rating-item{background:var(--surface);border:2px solid var(--border);border-radius:12px;
    padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem;cursor:pointer;
    transition:all .15s;user-select:none}
  .rating-item.selected-rank-1{border-color:var(--gold);background:#e9c46a18}
  .rating-item.selected-rank-2{border-color:#aaa;background:#aaa3}
  .rating-item.selected-rank-3{border-color:var(--blue);background:#457b9d18}
  .rating-rank{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--muted);width:2rem;text-align:center}
  .rating-rank.gold{color:var(--gold)}
  .rating-rank.silver{color:#aaa}
  .rating-rank.bronze{color:var(--blue)}
  .rank-hint{font-size:.7rem;color:var(--muted);text-align:center;padding:.25rem 0}

  /* â”€â”€ MAP â”€â”€ */
  #player-hex-svg{width:100%;max-height:45vh;display:block}
  .capture-bar{display:flex;align-items:center;justify-content:space-between;
    background:var(--surface);border-radius:10px;padding:.6rem 1rem}
  .capture-pts-num{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--gold)}
  .btn-capture{background:var(--teal);color:#fff;border:none;padding:.8rem 1.5rem;
    font-family:'Unbounded',sans-serif;font-size:.75rem;font-weight:700;
    border-radius:10px;cursor:pointer;transition:opacity .2s}
  .btn-capture:disabled{opacity:.35;cursor:default}
</style>
</head>
<body>

<!-- JOIN -->
<div id="screen-join" class="screen active" style="justify-content:center">
  <div class="join-logo">FallacyMania</div>
  <div style="display:flex;flex-direction:column;gap:.6rem;max-width:360px;width:100%;margin:0 auto">
    <input id="name-input" class="input-field" placeholder="Ğ’Ğ°ÑˆĞµ Ñ–Ğ¼'Ñ" maxlength="20">
    <input id="code-input" class="input-field" placeholder="ĞšĞ¾Ğ´ ĞºÑ–Ğ¼Ğ½Ğ°Ñ‚Ğ¸ (4 Ğ»Ñ–Ñ‚ĞµÑ€Ğ¸)"
      maxlength="4" style="text-transform:uppercase;letter-spacing:.2em;font-size:1.2rem;text-align:center">
    <button class="btn-join" onclick="joinRoom()">ĞŸÑ€Ğ¸Ñ”Ğ´Ğ½Ğ°Ñ‚Ğ¸ÑÑŒ</button>
    <div class="error-msg" id="error-msg"></div>
  </div>
</div>

<!-- WAITING LOBBY -->
<div id="screen-waiting" class="screen">
  <div class="waiting-center">
    <div class="waiting-emoji pulse" id="my-civ-emoji">ğŸ‘¤</div>
    <div class="waiting-text" id="my-name-display">Ğ’Ğ°ÑˆĞµ Ñ–Ğ¼'Ñ</div>
    <div id="my-civ-display" style="font-size:.85rem;color:var(--muted)">ĞÑ‡Ñ–ĞºÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ³Ñ€Ğ¸...</div>
  </div>
</div>

<!-- CIV SELECT -->
<div id="screen-civ" class="screen">
  <div class="phase-header">
    <div class="phase-tag">ĞšÑ€Ğ¾Ğº 1</div>
    <div class="phase-h">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ†Ğ¸Ğ²Ñ–Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ</div>
  </div>
  <div class="civ-list" id="civ-list"></div>
</div>

<!-- WAITING (in-game) -->
<div id="screen-waiting-game" class="screen">
  <div class="my-civ-bar">
    <span id="wg-civ-emoji">ğŸ‘¤</span>
    <div>
      <div style="font-size:.85rem;font-weight:600" id="wg-name">â€”</div>
      <div style="font-size:.7rem;color:var(--muted)" id="wg-civ">â€”</div>
    </div>
  </div>
  <div class="waiting-center">
    <div style="font-size:2.5rem;animation:pulse 2s infinite" id="wg-icon">â³</div>
    <div class="waiting-text" id="wg-message">Ğ—Ğ°Ñ‡ĞµĞºĞ°Ğ¹Ñ‚Ğµ...</div>
    <div class="waiting-sub" id="wg-sub"></div>
  </div>
</div>

<!-- ATTACK TURN -->
<div id="screen-attack" class="screen">
  <div class="phase-header">
    <div class="phase-tag">âš”ï¸ Ğ’Ğ°Ñˆ Ñ…Ñ–Ğ´ â€” ĞÑ‚Ğ°ĞºĞ°</div>
    <div class="phase-h">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ†Ñ–Ğ»ÑŒ Ñ– Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚</div>
  </div>

  <div class="section-label">Ğ¦Ñ–Ğ»ÑŒ Ğ°Ñ‚Ğ°ĞºĞ¸</div>
  <div class="target-list" id="target-list"></div>

  <div class="section-label" id="fact-section-label" style="display:none">Ğ¤Ğ°ĞºÑ‚ ĞºĞ¾Ğ½Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğ°Ñ†Ñ–Ñ—</div>
  <div class="fact-list" id="fact-list"></div>

  <div class="section-label">Ğ’Ğ°ÑˆÑ– ĞºĞ°Ñ€Ñ‚ĞºĞ¸-ÑĞ¾Ñ„Ñ–Ğ·Ğ¼Ğ¸</div>
  <div class="fallacy-mini-list" id="attack-fallacies"></div>

  <button class="btn-confirm" id="btn-attack-confirm" onclick="confirmAttack()" disabled>
    âš”ï¸ ĞÑ‚Ğ°ĞºÑƒÑ! (Ğ¿Ğ¾Ñ‚Ñ–Ğ¼ Ğ²Ğ¸ÑÑ‚ÑƒĞ¿Ğ°Ñ Ğ²Ğ³Ğ¾Ğ»Ğ¾Ñ)
  </button>
</div>

<!-- DEFENSE TURN -->
<div id="screen-defense" class="screen">
  <div class="phase-header">
    <div class="phase-tag">ğŸ›¡ï¸ Ğ—Ğ°Ñ…Ğ¸ÑÑ‚</div>
    <div class="phase-h">Ğ’Ğ°Ñ Ğ°Ñ‚Ğ°ĞºÑƒÑÑ‚ÑŒ!</div>
  </div>
  <div class="fact-display" id="defense-fact-display"></div>
  <div class="section-label" style="margin-top:.5rem">Ğ’Ğ°ÑˆÑ– ĞºĞ°Ñ€Ñ‚ĞºĞ¸-ÑĞ¾Ñ„Ñ–Ğ·Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ°Ñ…Ğ¸ÑÑ‚Ñƒ</div>
  <div class="fallacy-mini-list" id="defense-fallacies"></div>
  <div class="defense-actions">
    <button class="btn-speak" onclick="chooseDefense('speak')">
      ğŸ—£ï¸ Ğ—Ğ°Ñ…Ğ¸Ñ‰Ğ°ÑÑÑŒ (Ğ²Ğ¸Ğ±ĞµÑ€Ğ¸ ĞºĞ°Ñ€Ñ‚ĞºÑƒ Ñ– Ğ²Ğ¸ÑÑ‚ÑƒĞ¿Ğ¸)
    </button>
    <button class="btn-silence" onclick="chooseDefense('silence')">
      ğŸ¤ ĞŸÑ€Ğ¾Ğ¼Ğ¾Ğ²Ñ‡Ğ°Ñ‚Ğ¸ (-1 Ğ±Ğ°Ğ», Ğ°Ğ»Ğµ Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾)
    </button>
  </div>
</div>

<!-- CANCEL VOTE -->
<div id="screen-cancel" class="screen">
  <div class="phase-header">
    <div class="phase-tag">ğŸš« Ğ“Ğ¾Ğ»Ğ¾ÑÑƒĞ²Ğ°Ğ½Ğ½Ñ</div>
    <div class="phase-h">Cancel Ğ·Ğ°Ñ…Ğ¸ÑĞ½Ğ¸Ğº?</div>
  </div>
  <div style="background:var(--surface);border-radius:12px;padding:1rem;text-align:center">
    <div style="font-size:1.5rem" id="cancel-defender-emoji">ğŸ›¡ï¸</div>
    <div style="font-family:'Unbounded',sans-serif;font-size:.95rem;margin-top:.4rem" id="cancel-defender-name">â€”</div>
    <div style="font-size:.8rem;color:var(--muted);margin-top:.25rem">Ğ§Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ¾Ğ½Ğ»Ğ¸Ğ²Ğ¾ Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ğ²ÑÑ?</div>
  </div>
  <div class="cancel-btns" id="cancel-btns">
    <button class="btn-cancel-vote red" onclick="castCancelVote('cancel')">ğŸš«<br><span style="font-size:.7rem;font-family:'Unbounded',sans-serif">Cancel</span></button>
    <button class="btn-cancel-vote green" onclick="castCancelVote('ok')">âœ…<br><span style="font-size:.7rem;font-family:'Unbounded',sans-serif">OK</span></button>
  </div>
  <div id="cancel-voted-msg" style="display:none;text-align:center;padding:1rem;color:var(--muted);font-size:.85rem">
    âœ“ Ğ’Ğ°Ñˆ Ğ³Ğ¾Ğ»Ğ¾Ñ Ğ²Ñ€Ğ°Ñ…Ğ¾Ğ²Ğ°Ğ½Ğ¾
  </div>
</div>

<!-- RATING -->
<div id="screen-rating" class="screen">
  <div class="phase-header">
    <div class="phase-tag">â­ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³</div>
    <div class="phase-h">Ğ¥Ñ‚Ğ¾ Ğ²Ğ¸ÑÑ‚ÑƒĞ¿Ğ¸Ğ² Ğ½Ğ°Ğ¹ĞºÑ€Ğ°Ñ‰Ğµ?</div>
  </div>
  <div class="rank-hint" id="rank-instruction">ĞĞ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ğ½Ğ° Ğ³Ñ€Ğ°Ğ²Ñ†Ñ Ñ‰Ğ¾Ğ± Ğ´Ğ°Ñ‚Ğ¸ Ğ¹Ğ¾Ğ¼Ñƒ ğŸ¥‡ 1 Ğ¼Ñ–ÑÑ†Ğµ</div>
  <div class="rating-list" id="rating-list"></div>
  <button class="btn-confirm" id="btn-rating-confirm" onclick="submitRating()" disabled>
    â­ ĞŸÑ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğ¸ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³
  </button>
</div>

<!-- MAP -->
<div id="screen-map" class="screen">
  <div class="phase-header">
    <div class="phase-tag">ğŸ—ºï¸ Ğ—Ğ°Ñ…Ğ²Ğ°Ñ‚</div>
    <div class="phase-h">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ ĞºĞ»Ñ–Ñ‚Ğ¸Ğ½ĞºĞ¸</div>
  </div>
  <div class="capture-bar">
    <div>
      <div style="font-size:.7rem;color:var(--muted)">ĞÑ‡ĞºĞ¸ Ğ´Ğ»Ñ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñƒ</div>
      <div class="capture-pts-num" id="capture-pts">0</div>
      <div id="capture-info" style="font-size:.7rem;color:var(--muted)"></div>
    </div>
    <button class="btn-capture" id="btn-capture" onclick="confirmCapture()" disabled>Ğ—Ğ°Ñ…Ğ¾Ğ¿Ğ¸Ñ‚Ğ¸</button>
  </div>
  <svg id="player-hex-svg" viewBox="0 0 0 0" xmlns="http://www.w3.org/2000/svg"></svg>
</div>

<!-- RESULT -->
<div id="screen-result" class="screen">
  <div class="waiting-center">
    <div style="font-size:1rem;color:var(--muted)">ĞÑ‡ĞºĞ¸ Ğ·Ğ° Ñ€Ğ°ÑƒĞ½Ğ´</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:6rem;color:var(--gold)" id="result-pts">0</div>
    <div class="waiting-sub pulse">ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ñ€Ğ°ÑƒĞ½Ğ´...</div>
  </div>
</div>

<script>
const WS_URL = location.protocol==='https:'
  ? `wss://${location.host}/ws`
  : `ws://${location.host}/ws`;

let ws, playerId, myColor, myName;
let myCivId=null, myCivName=null, myCivEmoji=null;
let capturePoints=0, selectedCells=[], mapData=null, mapPlayers={};
let attackState={ targetId:null, factId:null, fallacyId:null, cards:[], targets:[], factsPreview:{} };
let defenseState={ cards:[], fallacyId:null };
let players={};

// â”€â”€ CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connect() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => console.log('WS connected');
  ws.onmessage = e => { try{ handle(JSON.parse(e.data)); }catch(err){ console.error(err); } };
  ws.onerror = () => showError('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ');
  ws.onclose = e => { showError('Ğ—\'Ñ”Ğ´Ğ½Ğ°Ğ½Ğ½Ñ Ğ²Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾. ĞŸĞµÑ€ĞµĞ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ...'); setTimeout(connect,3000); };
}
function send(obj){ if(ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify(obj)); }

// â”€â”€ JOIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joinRoom(){
  const code=document.getElementById('code-input').value.trim().toUpperCase();
  const name=document.getElementById('name-input').value.trim()||'Ğ“Ñ€Ğ°Ğ²ĞµÑ†ÑŒ';
  if(code.length<4){ showError('Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ 4-Ğ»Ñ–Ñ‚ĞµÑ€Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ´'); return; }
  myName=name;
  send({ type:'join_room', code, name });
}
function showError(msg){
  document.getElementById('error-msg').textContent=msg;
  setTimeout(()=>document.getElementById('error-msg').textContent='',3000);
}

// â”€â”€ HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handle(msg){
  switch(msg.type){
    case 'joined':
      playerId=msg.playerId; myColor=msg.color;
      document.getElementById('my-name-display').textContent=myName;
      document.getElementById('wg-name').textContent=myName;
      showScreen('screen-waiting');
      break;

    case 'player_joined':
    case 'player_left':
    case 'civ_update':
      if(msg.players){ players={}; msg.players.forEach(p=>players[p.id]=p); }
      break;

    case 'error':
      showError(msg.msg); break;

    case 'civ_chosen':
      myCivId=msg.civ.id; myCivName=msg.civ.name; myCivEmoji=msg.civ.emoji;
      document.getElementById('my-civ-emoji').textContent=msg.civ.emoji;
      document.getElementById('my-civ-display').textContent=msg.civ.name;
      setWaiting('âœ“','Ğ¦Ğ¸Ğ²Ñ–Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾','Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ñ–Ğ½ÑˆĞ¸Ñ… Ğ³Ñ€Ğ°Ğ²Ñ†Ñ–Ğ²...');
      showScreen('screen-waiting');
      break;

    case 'phase':
      handlePhase(msg); break;

    case 'round_start':
      if(msg.players){ players={}; msg.players.forEach(p=>players[p.id]=p); }
      setWaiting('âš”ï¸','Ğ Ğ°ÑƒĞ½Ğ´ ' + msg.round + ' Ğ¿Ğ¾Ñ‡Ğ¸Ğ½Ğ°Ñ”Ñ‚ÑŒÑÑ','Ğ“Ğ¾Ñ‚ÑƒĞ¹Ñ‚ĞµÑÑŒ!');
      showScreen('screen-waiting-game');
      break;

    case 'your_attack_turn':
      renderAttackTurn(msg); break;

    case 'your_defense_turn':
      renderDefenseTurn(msg); break;

    case 'defense_result':
      if(msg.defenderId===playerId && msg.choice==='silence'){
        setWaiting('ğŸ¤','Ğ’Ğ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾Ğ²Ñ‡Ğ°Ğ»Ğ¸','ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ°Ñ‚Ğ°ĞºĞ°...');
        showScreen('screen-waiting-game');
      }
      break;

    case 'cancel_result':
      setWaiting(msg.cancelled?'âœ—':'âœ“',
        msg.cancelled?'Ğ’Ğ°Ñˆ Ğ·Ğ°Ñ…Ğ¸ÑÑ‚ ÑĞºĞ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¾ (-4)':'Ğ—Ğ°Ñ…Ğ¸ÑÑ‚ Ğ¿Ñ€Ğ¸Ğ¹Ğ½ÑÑ‚Ğ¸Ğ¹ (+3)',
        'ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ°Ñ‚Ğ°ĞºĞ°...');
      showScreen('screen-waiting-game');
      break;

    case 'rating_result':
      const myPts = msg.roundScores?.[playerId]||0;
      document.getElementById('result-pts').textContent = (myPts>=0?'+':'')+myPts;
      showScreen('screen-result');
      break;

    case 'map_turn':
      capturePoints=msg.capturePoints||0;
      mapData=msg.map;
      if(msg.players){ mapPlayers={}; msg.players.forEach(p=>mapPlayers[p.id]=p); }
      selectedCells=[];
      document.getElementById('capture-pts').textContent=capturePoints;
      const capBtn=document.getElementById('btn-capture');
      if(capBtn) capBtn.disabled=true;
      // ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾ÑÑĞ½ĞµĞ½Ğ½Ñ ÑĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ° Ğ¾Ñ‡Ğ¾Ğº
      const capInfo=document.getElementById('capture-info');
      if(capInfo) capInfo.textContent=capturePoints<=0
        ? 'ĞĞµĞ¼Ğ°Ñ” Ğ¾Ñ‡Ğ¾Ğº Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñƒ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ€Ğ°ÑƒĞ½Ğ´Ñƒ'
        : `ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ ${capturePoints} ÑÑƒÑÑ–Ğ´Ğ½Ñ–Ñ… ĞºĞ»Ñ–Ñ‚Ğ¸Ğ½Ğ¾Ğº`;
      renderHexMap();
      showScreen('screen-map');
      break;

    case 'map_update':
      mapData=msg.map; renderHexMap(); break;
  }
}

function handlePhase(msg){
  if(msg.players){ players={}; msg.players.forEach(p=>players[p.id]=p); }
  switch(msg.phase){
    case 'civ_select':
      renderCivSelect(msg.civilizations); showScreen('screen-civ'); break;
    case 'attack_prep':
      if(msg.attackerId!==playerId){
        const a=players[msg.attackerId];
        setWaiting(a?.civEmoji||'âš”ï¸',
          `${a?.name||'?'} Ğ°Ñ‚Ğ°ĞºÑƒÑ”...`,
          `${a?.civName||''} Ğ³Ğ¾Ñ‚ÑƒÑ” Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¸`);
        showScreen('screen-waiting-game');
      }
      break;
    case 'defense':
      if(msg.defenderId!==playerId){
        const d=players[msg.defenderId];
        setWaiting(d?.civEmoji||'ğŸ›¡ï¸',
          `${d?.name||'?'} Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ñ”Ñ‚ÑŒÑÑ...`,
          '');
        showScreen('screen-waiting-game');
      }
      break;
    case 'cancel_vote':
      if(msg.defenderId!==playerId){
        const d=players[msg.defenderId];
        document.getElementById('cancel-defender-emoji').textContent=d?.civEmoji||'ğŸ›¡ï¸';
        document.getElementById('cancel-defender-name').textContent=`${d?.name||'?'} â€” ${d?.civName||''}`;
        document.querySelectorAll('.btn-cancel-vote').forEach(b=>b.disabled=false);
        document.getElementById('cancel-voted-msg').style.display='none';
        document.getElementById('cancel-btns').style.display='grid';
        showScreen('screen-cancel');
      } else {
        setWaiting('ğŸš«','Ğ“Ñ€Ğ°Ğ²Ñ†Ñ– Ğ³Ğ¾Ğ»Ğ¾ÑÑƒÑÑ‚ÑŒ...','Ğ§Ğ¸ Ğ¿Ñ€Ğ¸Ğ¹Ğ½ÑÑ‚Ğ¸Ğ¹ Ğ²Ğ°Ñˆ Ğ·Ğ°Ñ…Ğ¸ÑÑ‚?');
        showScreen('screen-waiting-game');
      }
      break;
    case 'rating':
      renderRating(msg); showScreen('screen-rating'); break;
    case 'round_end':
      setWaiting('ğŸ','ĞšÑ–Ğ½ĞµÑ†ÑŒ Ñ€Ğ°ÑƒĞ½Ğ´Ñƒ','ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ ÑĞºĞ¾Ñ€Ğ¾...');
      showScreen('screen-waiting-game'); break;
  }
}

function setWaiting(icon,text,sub){
  document.getElementById('wg-icon').textContent=icon;
  document.getElementById('wg-message').textContent=text;
  document.getElementById('wg-sub').textContent=sub||'';
  document.getElementById('wg-civ-emoji').textContent=myCivEmoji||'ğŸ‘¤';
  document.getElementById('wg-civ').textContent=myCivName||'';
}

// â”€â”€ CIV SELECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCivSelect(civs){
  const el=document.getElementById('civ-list');
  el.innerHTML=civs.map(c=>{
    const takenBy=Object.values(players).find(p=>p.civId===c.id && p.id!==playerId);
    return `<button class="civ-btn" ${takenBy?'disabled':''} onclick="chooseCiv('${c.id}',this)">
      <div class="civ-btn-emoji">${c.emoji}</div>
      <div>
        <div class="civ-btn-name">${c.name}</div>
        <div class="civ-btn-desc">${c.description||c.era}</div>
        ${takenBy?`<div class="civ-taken">âœ— ĞĞ±Ñ€Ğ°Ğ½Ğ¾: ${takenBy.name}</div>`:''}
      </div>
    </button>`;
  }).join('');
}

function chooseCiv(civId,btn){
  document.querySelectorAll('.civ-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  send({ type:'choose_civ', civId });
}

// â”€â”€ ATTACK TURN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAttackTurn(msg){
  attackState={ targetId:null, factId:null, fallacyId:null,
    cards:msg.cards||[], targets:msg.targets||[], factsPreview:msg.factsPreview||{} };

  // Ğ¦Ñ–Ğ»Ñ–
  const tl=document.getElementById('target-list');
  tl.innerHTML=(msg.targets||[]).map(t=>`
    <button class="target-btn" onclick="selectTarget('${t.id}',this)">
      <div class="target-btn-civ">${t.civEmoji||'ğŸ‘¤'}</div>
      <div>
        <div style="font-weight:600;font-size:.9rem">${t.name}</div>
        <div style="font-size:.75rem;color:var(--muted)">${t.civName||''}</div>
        <div style="font-size:.65rem;color:var(--blue)">${(msg.factsPreview||{})[t.id]?.length||0} Ñ„Ğ°ĞºÑ‚Ñ–Ğ²</div>
      </div>
    </button>`).join('');

  document.getElementById('fact-section-label').style.display='none';
  document.getElementById('fact-list').innerHTML='';

  // ĞšĞ°Ñ€Ñ‚ĞºĞ¸
  renderFallacyMiniList('attack-fallacies', msg.cards||[], id=>{
    attackState.fallacyId=id; checkAttackReady();
  });

  document.getElementById('btn-attack-confirm').disabled=true;
  showScreen('screen-attack');
}

function selectTarget(id,btn){
  attackState.targetId=id; attackState.factId=null;
  document.querySelectorAll('.target-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  // ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ñ„Ğ°ĞºÑ‚Ğ¸ Ğ´Ğ»Ñ Ñ†Ñ–Ñ”Ñ— Ñ†Ñ–Ğ»Ñ–
  const facts=attackState.factsPreview[id]||[];
  const label=document.getElementById('fact-section-label');
  label.style.display='block';
  label.textContent=facts.length>0 ? `Ğ¤Ğ°ĞºÑ‚ ĞºĞ¾Ğ½Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğ°Ñ†Ñ–Ñ— (${facts.length} Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ñ…)` : 'Ğ¤Ğ°ĞºÑ‚Ğ¸ ĞºĞ¾Ğ½Ñ„Ñ€Ğ¾Ğ½Ñ‚Ğ°Ñ†Ñ–Ñ— Ğ²Ñ–Ğ´ÑÑƒÑ‚Ğ½Ñ–';
  const fl=document.getElementById('fact-list');
  if(facts.length===0){
    fl.innerHTML=`<div style="color:var(--muted);font-size:.8rem;padding:.5rem">ĞĞµĞ¼Ğ°Ñ” Ñ„Ğ°ĞºÑ‚Ñ–Ğ² Ğ´Ğ»Ñ Ñ†Ñ–Ñ”Ñ— Ğ¿Ğ°Ñ€Ğ¸ Ñ†Ğ¸Ğ²Ñ–Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ğ¹</div>`;
    checkAttackReady();
    return;
  }
  fl.innerHTML=facts.map(f=>`
    <button class="fact-btn" onclick="selectFact('${f.id}',this)">
      <div class="fact-btn-title">ğŸ“œ ${f.title}</div>
    </button>`).join('');
  checkAttackReady();
}

function selectFact(id,btn){
  attackState.factId=id;
  document.querySelectorAll('.fact-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  checkAttackReady();
}

function checkAttackReady(){
  const ok=attackState.targetId&&attackState.factId&&attackState.fallacyId;
  document.getElementById('btn-attack-confirm').disabled=!ok;
}

function confirmAttack(){
  send({ type:'choose_attack', defenderId:attackState.targetId,
    factId:attackState.factId, fallacyId:attackState.fallacyId });
  setWaiting('ğŸ—£ï¸','Ğ¢ĞµĞ¿ĞµÑ€ Ğ²Ğ¸ÑÑ‚ÑƒĞ¿Ğ°Ğ¹Ñ‚Ğµ Ğ²Ğ³Ğ¾Ğ»Ğ¾Ñ!','Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ¹Ñ‚Ğµ ÑĞ²Ñ–Ğ¹ Ñ„Ğ°ĞºÑ‚ Ñ– ÑĞ¾Ñ„Ñ–Ğ·Ğ¼');
  showScreen('screen-waiting-game');
}

// â”€â”€ DEFENSE TURN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDefenseTurn(msg){
  defenseState={ cards:msg.cards||[], fallacyId:null };

  const fd=document.getElementById('defense-fact-display');
  if(msg.fact){
    fd.innerHTML=`
      <div class="fact-display-title">ğŸ“œ ${msg.fact.title}</div>
      <div class="fact-display-body">${msg.fact.body}</div>
      <div class="attacker-angle">âš”ï¸ ĞÑ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸ Ğ²Ğ°Ñ: ${msg.attackerAngle||msg.fact.defender_angle}</div>
      ${msg.fact.defender_angle?`<div class="defender-angle">ğŸ›¡ï¸ ĞŸÑ–Ğ´ĞºĞ°Ğ·ĞºĞ°: ${msg.fact.defender_angle}</div>`:''}`;
  }

  renderFallacyMiniList('defense-fallacies', msg.cards||[], id=>{
    defenseState.fallacyId=id;
  });

  showScreen('screen-defense');
}

function chooseDefense(choice){
  if(choice==='silence'){
    send({ type:'defense_choice', choice:'silence' });
  } else {
    send({ type:'defense_choice', choice:'speak', fallacyId:defenseState.fallacyId, speech:true });
    setWaiting('ğŸ—£ï¸','Ğ—Ğ°Ñ…Ğ¸Ñ‰Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ğ²Ğ³Ğ¾Ğ»Ğ¾Ñ!','ĞŸĞ¾Ñ‚Ñ–Ğ¼ Ğ³Ñ€Ğ°Ğ²Ñ†Ñ– Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑÑƒÑÑ‚ÑŒ Ğ·Ğ° cancel');
    showScreen('screen-waiting-game');
  }
}

// â”€â”€ CANCEL VOTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function castCancelVote(vote){
  send({ type:'cancel_vote', vote });
  document.querySelectorAll('.btn-cancel-vote').forEach(b=>b.disabled=true);
  document.getElementById('cancel-btns').style.display='none';
  document.getElementById('cancel-voted-msg').style.display='block';
}

// â”€â”€ RATING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ratingPicks = []; // [playerId, playerId, ...] Ğ²Ñ–Ğ´ 1 Ğ´Ğ¾ topCount Ğ¼Ñ–ÑÑ†ÑŒ
let ratingTopCount = 1;

function renderRating(msg){
  const plist=Object.values(players).filter(p=>p.id!==playerId);
  ratingPicks=[];
  ratingTopCount = msg?.topCount || (plist.length >= 5 ? 3 : plist.length >= 3 ? 2 : 1);
  updateRatingInstruction();
  const rl=document.getElementById('rating-list');
  rl.innerHTML=plist.map(p=>`
    <div class="rating-item" id="ri-${p.id}" onclick="tapRatingItem('${p.id}')">
      <div class="rating-rank" id="rr-${p.id}">â€”</div>
      <div style="font-size:1.3rem">${p.civEmoji||'ğŸ‘¤'}</div>
      <div>
        <div style="font-weight:600;font-size:.9rem">${p.name}</div>
        <div style="font-size:.7rem;color:var(--muted)">${p.civName||''}</div>
      </div>
    </div>`).join('');
  document.getElementById('btn-rating-confirm').disabled=true;
}

function updateRatingInstruction(){
  const el=document.getElementById('rank-instruction');
  if(!el) return;
  const labels=['ğŸ¥‡ 1 Ğ¼Ñ–ÑÑ†Ğµ','ğŸ¥ˆ 2 Ğ¼Ñ–ÑÑ†Ğµ','ğŸ¥‰ 3 Ğ¼Ñ–ÑÑ†Ğµ'];
  const next=ratingPicks.length;
  if(next < ratingTopCount){
    el.textContent=`ĞĞ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ğ½Ğ° Ğ³Ñ€Ğ°Ğ²Ñ†Ñ â†’ ${labels[next]||`${next+1} Ğ¼Ñ–ÑÑ†Ğµ`}`;
    el.style.color='var(--gold)';
  } else {
    el.textContent=`âœ“ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ĞĞ±Ğ¾ Ğ½Ğ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ñ‰Ğ¾Ğ± Ğ·Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸`;
    el.style.color='var(--teal)';
  }
}

function tapRatingItem(pid){
  const existIdx = ratingPicks.indexOf(pid);
  if(existIdx >= 0){
    // Ğ—Ğ½Ñ–Ğ¼Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ¸Ğ±Ñ–Ñ€ â€” Ñ– Ğ²ÑÑ– Ğ¿Ñ–ÑĞ»Ñ Ğ½ÑŒĞ¾Ğ³Ğ¾
    ratingPicks = ratingPicks.slice(0, existIdx);
  } else if(ratingPicks.length < ratingTopCount){
    ratingPicks.push(pid);
  } else {
    // Ğ’ÑÑ– Ğ¼Ñ–ÑÑ†Ñ Ğ·Ğ°Ğ¹Ğ½ÑÑ‚Ñ– â€” Ğ·Ğ°Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ”
    ratingPicks[ratingTopCount-1] = pid;
  }
  refreshRatingUI();
}

function refreshRatingUI(){
  const rankLabels=[{cls:'gold',sym:'ğŸ¥‡'},{cls:'silver',sym:'ğŸ¥ˆ'},{cls:'bronze',sym:'ğŸ¥‰'}];
  // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ²ÑÑ–
  document.querySelectorAll('.rating-item').forEach(el=>{
    el.className='rating-item';
  });
  document.querySelectorAll('.rating-rank').forEach(el=>{ el.textContent='â€”'; el.className='rating-rank'; });

  // Ğ¡Ñ‚Ğ°Ğ²Ğ¸Ğ¼Ğ¾ Ğ²Ğ¸Ğ±Ñ€Ğ°Ğ½Ñ–
  ratingPicks.forEach((pid,i)=>{
    const item=document.getElementById(`ri-${pid}`);
    const rank=document.getElementById(`rr-${pid}`);
    const lbl=rankLabels[i]||{cls:'',sym:`${i+1}`};
    if(item) item.classList.add(`selected-rank-${i+1}`);
    if(rank){ rank.textContent=lbl.sym; rank.className=`rating-rank ${lbl.cls}`; }
  });

  updateRatingInstruction();
  const allDone = ratingPicks.length >= Math.min(ratingTopCount, Object.values(players).filter(p=>p.id!==playerId).length);
  document.getElementById('btn-rating-confirm').disabled = !allDone;
}

function submitRating(){
  if(ratingPicks.length===0) return;
  send({ type:'submit_rating', ranked:ratingPicks });
  document.getElementById('btn-rating-confirm').disabled=true;
  document.getElementById('rank-instruction').textContent='âœ“ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾';
}

// â”€â”€ FALLACY HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFallacyMiniList(elId, cards, onSelect){
  const el=document.getElementById(elId);
  const tagColors={'Ğ°Ñ‚Ğ°ĞºĞ°':'#e63946','ÑĞ¿Ğ¾Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ':'#f4a261','Ğ»Ğ¾Ğ³Ñ–ĞºĞ°':'#118ab2',
    'Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚':'#8ecae6','Ğ¼Ğ°Ğ½Ñ–Ğ¿ÑƒĞ»ÑÑ†Ñ–Ñ':'#e9c46a','Ğ²Ñ–Ğ´Ğ²Ğ¾Ğ»Ñ–ĞºĞ°Ğ½Ğ½Ñ':'#2a9d8f'};
  el.innerHTML=cards.map(c=>`
    <div class="fallacy-mini" onclick="selectFallacyMini(this,'${elId}','${c.id}')">
      <div>
        <div class="fallacy-mini-name">${c.name}</div>
        <div style="font-size:.7rem;color:var(--muted);margin-top:.2rem">${c.desc||c.hint||''}</div>
      </div>
      <span class="fallacy-mini-tag" style="background:${tagColors[c.tag]||'var(--border)'}22;
        color:${tagColors[c.tag]||'var(--muted)'};margin-left:auto;white-space:nowrap">${c.tag||''}</span>
    </div>`).join('');
  el._onSelect=onSelect;
}

function selectFallacyMini(el,listId,id){
  document.querySelectorAll(`#${listId} .fallacy-mini`).forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  const list=document.getElementById(listId);
  if(list._onSelect) list._onSelect(parseInt(id));
}

// â”€â”€ HEX MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hexOffsets(row){
  return row%2===0?[[-1,-1],[-1,0],[0,-1],[0,1],[1,-1],[1,0]]:[[-1,0],[-1,1],[0,-1],[0,1],[1,0],[1,1]];
}
function isAdjacentToMe(cellId){
  if(!mapData) return false;
  const cell=mapData.cells.find(c=>c.id===cellId);
  if(!cell||cell.owner===playerId) return false;
  return hexOffsets(cell.row).some(([dr,dc])=>{
    const nb=mapData.cells.find(c=>c.row===cell.row+dr&&c.col===cell.col+dc);
    return nb&&nb.owner===playerId;
  });
}
function hexPts(cx,cy,r){
  return Array.from({length:6},(_,i)=>{
    const a=Math.PI/180*(60*i-30);
    return `${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`;
  }).join(' ');
}
function renderHexMap(){
  if(!mapData) return;
  const svg=document.getElementById('player-hex-svg');
  if(!svg) return;
  const R=14,W=R*Math.sqrt(3),PAD=R+2;
  const GRID=mapData.grid;
  const totalW=GRID*W+PAD*2,totalH=GRID*R*2*0.75+R*0.5+PAD*2;
  svg.setAttribute('viewBox',`0 0 ${totalW} ${totalH}`);
  svg.style.touchAction='none';

  let html='';
  mapData.cells.forEach(cell=>{
    const cx=PAD+cell.col*W+(cell.row%2===1?W/2:0)+W/2;
    const cy=PAD+cell.row*R*2*0.75+R;
    const isMe=cell.owner===playerId;
    const isSel=selectedCells.includes(cell.id);
    const adj=!isMe&&capturePoints>0&&isAdjacentToMe(cell.id);
    const owner=cell.owner?(mapPlayers[cell.owner]||players[cell.owner]):null;
    let fill=owner?owner.color:'#1a1a2e';
    let stroke='rgba(0,0,0,0.3)', sw=0.5;
    if(isSel){ stroke='#e9c46a'; sw=2.5; }
    else if(adj){ stroke='rgba(255,255,255,0.7)'; sw=1.5; }
    html+=`<polygon data-cell="${cell.id}" points="${hexPts(cx,cy,R-1)}"
      fill="${fill}" stroke="${stroke}" stroke-width="${sw}"
      style="cursor:${adj||isSel?'pointer':'default'}"/>`;
    if(isMe) html+=`<circle cx="${cx}" cy="${cy}" r="3" fill="rgba(255,255,255,0.35)" pointer-events="none"/>`;
    else if(isSel) html+=`<circle cx="${cx}" cy="${cy}" r="3.5" fill="#e9c46a" pointer-events="none"/>`;
    else if(adj) html+=`<polygon points="${hexPts(cx,cy,R-1)}" fill="white" opacity="0.1" pointer-events="none"/>`;
  });
  svg.innerHTML=html;

  // Ğ’Ñ–ÑˆĞ°Ñ”Ğ¼Ğ¾ Ğ¾Ğ´Ğ¸Ğ½ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº Ğ½Ğ° SVG (event delegation) â€” Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ñ– Ğ½Ğ° touch Ñ– Ğ½Ğ° mouse
  svg.onclick=null; svg.ontouchend=null;
  svg.addEventListener('pointerdown', handleMapPointer, {passive:false});
}

function handleMapPointer(e){
  e.preventDefault();
  const poly=e.target.closest('polygon[data-cell]');
  if(!poly) return;
  toggleCell(parseInt(poly.dataset.cell));
}

function toggleCell(cellId){
  if(capturePoints<=0) return;
  const cell=mapData.cells.find(c=>c.id===cellId);
  if(!cell||cell.owner===playerId) return;
  if(!isAdjacentToMe(cellId)) return;
  const idx=selectedCells.indexOf(cellId);
  if(idx>=0){ selectedCells.splice(idx,1); }
  else{ if(selectedCells.length>=capturePoints) return; selectedCells.push(cellId); }
  renderHexMap();
  const btn=document.getElementById('btn-capture');
  if(btn) btn.disabled=selectedCells.length===0;
}
function confirmCapture(){
  if(!selectedCells.length) return;
  send({ type:'capture', cellIds:selectedCells });
  capturePoints-=selectedCells.length;
  selectedCells=[];
  const pts=document.getElementById('capture-pts');
  if(pts) pts.textContent=capturePoints;
  const btn=document.getElementById('btn-capture');
  if(btn) btn.disabled=true;
  renderHexMap();
}

// â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-join').style.display='none';
  const t=document.getElementById(id);
  if(t) t.classList.add('active');
}

connect();
</script>
</body>
</html>