<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>FallacyMania — Гравець</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Unbounded:wght@400;700;900&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #1e1e2e;
    --accent: #ff3c5f;
    --gold: #ffd166;
    --teal: #06d6a0;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --my-color: #ff3c5f;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    max-width: 430px;
    margin: 0 auto;
    overflow-x: hidden;
  }

  .screen { display: none; flex-direction: column; min-height: 100vh; padding: 1.5rem; }
  .screen.active { display: flex; }

  /* ── JOIN SCREEN ── */
  #screen-join {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    min-height: 100vh;
    padding: 2rem;
  }

  .logo-small {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3rem;
    letter-spacing: 0.08em;
    background: linear-gradient(135deg, #ff3c5f, #ffd166);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .input-group { width: 100%; display: flex; flex-direction: column; gap: 0.5rem; }

  .input-label {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .input-field {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem 1.2rem;
    color: var(--text);
    font-family: 'Unbounded', sans-serif;
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.2s;
  }
  .input-field:focus { border-color: var(--accent); }
  .input-field.name-field { text-transform: none; letter-spacing: 0; }

  .btn-join {
    width: 100%;
    background: var(--accent);
    color: white;
    border: none;
    font-family: 'Unbounded', sans-serif;
    font-size: 1rem;
    font-weight: 700;
    padding: 1rem;
    border-radius: 10px;
    cursor: pointer;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .btn-join:active { transform: scale(0.97); }

  .error-msg { color: var(--accent); font-size: 0.85rem; text-align: center; min-height: 1.2em; }

  /* ── WAITING SCREEN ── */
  #screen-waiting {
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    text-align: center;
  }

  .waiting-icon {
    width: 80px; height: 80px;
    border-radius: 50%;
    background: var(--my-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,60,95,0.4); }
    50% { box-shadow: 0 0 0 20px rgba(255,60,95,0); }
  }

  .waiting-name {
    font-family: 'Unbounded', sans-serif;
    font-size: 1.2rem;
    font-weight: 700;
  }

  .waiting-sub { font-size: 0.9rem; color: var(--muted); }

  /* ── TOPIC SELECT ── */
  .phase-top {
    margin-bottom: 1.5rem;
  }
  .phase-tag {
    display: inline-block;
    font-family: 'Unbounded', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--accent);
    background: rgba(255,60,95,0.1);
    padding: 0.3rem 0.8rem;
    border-radius: 100px;
    margin-bottom: 0.5rem;
  }
  .phase-h {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    letter-spacing: 0.05em;
    line-height: 1;
  }
  .phase-sub { font-size: 0.85rem; color: var(--muted); margin-top: 0.3rem; }

  .topics-list { display: flex; flex-direction: column; gap: 0.75rem; flex: 1; }

  .topic-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.2rem 1.5rem;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .topic-btn::before {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(135deg, var(--accent), var(--gold));
    opacity: 0;
    transition: opacity 0.2s;
  }
  .topic-btn span { position: relative; z-index: 1; }
  .topic-btn:active { transform: scale(0.98); }
  .topic-btn.selected { border-color: var(--teal); background: rgba(6,214,160,0.1); }
  .topic-btn.selected::before { opacity: 0.05; }

  .chosen-topic {
    background: var(--surface);
    border: 1px solid var(--teal);
    border-radius: 12px;
    padding: 1.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    color: var(--teal);
    margin-bottom: 1rem;
  }

  /* ── FALLACY CARDS ── */
  .fallacy-cards { display: flex; flex-direction: column; gap: 0.75rem; flex: 1; overflow-y: auto; }

  .fallacy-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.2rem;
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }

  .fallacy-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2rem;
    color: var(--accent);
    line-height: 1;
    flex-shrink: 0;
    width: 2.5rem;
    text-align: center;
  }

  .fallacy-info {}
  .fallacy-name {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
  }
  .fallacy-desc { font-size: 0.8rem; color: var(--muted); line-height: 1.5; }

  .topic-reminder {
    background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(6,214,160,0.1));
    border: 1px solid rgba(255,209,102,0.2);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    margin-bottom: 1rem;
  }
  .topic-reminder-label {
    font-family: 'Unbounded', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.3rem;
  }
  .topic-reminder-text {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--gold);
  }

  /* ── VOTE ── */
  .vote-list { display: flex; flex-direction: column; gap: 0.75rem; flex: 1; }

  .vote-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.2rem 1.5rem;
    color: var(--text);
    font-family: 'Unbounded', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .vote-btn.voted { opacity: 0.5; cursor: default; }
  .vote-btn.my-vote { border-color: var(--teal); background: rgba(6,214,160,0.08); }
  .vote-btn:active:not(.voted) { transform: scale(0.98); }

  /* ── MAP ── */
  .capture-info {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .capture-pts-label { font-size: 0.8rem; color: var(--muted); }
  .capture-pts {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    color: var(--gold);
    letter-spacing: 0.05em;
  }

  .map-grid-phone {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 2px;
    margin-bottom: 1rem;
  }

  .map-cell-phone {
    aspect-ratio: 1;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
  }

  .map-cell-phone.capturable { cursor: pointer; box-shadow: 0 0 0 2px white; }
  .map-cell-phone.selected { box-shadow: 0 0 0 2px var(--gold) !important; transform: scale(0.9); }
  .map-cell-phone.mine { cursor: default; }

  .btn-capture {
    background: var(--gold);
    color: var(--bg);
    border: none;
    font-family: 'Unbounded', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    padding: 1rem;
    border-radius: 10px;
    cursor: pointer;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    width: 100%;
    transition: all 0.2s;
  }
  .btn-capture:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-capture:active:not(:disabled) { transform: scale(0.97); }

  /* ── RESULT ── */
  #screen-result {
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 1.5rem;
  }
  .result-big {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 5rem;
    color: var(--gold);
    letter-spacing: 0.05em;
    line-height: 1;
  }
  .result-msg { font-size: 1rem; color: var(--muted); }

  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--teal);
    display: inline-block;
    margin-right: 6px;
    animation: blink 1.5s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
</style>
</head>
<body>

<!-- JOIN -->
<div id="screen-join">
  <div class="logo-small">FallacyMania</div>
  <div class="input-group">
    <div class="input-label">Код кімнати</div>
    <input class="input-field" id="code-input" placeholder="ABCD" maxlength="4">
  </div>
  <div class="input-group">
    <div class="input-label">Ваше ім'я</div>
    <input class="input-field name-field" id="name-input" placeholder="Ваш нікнейм" maxlength="16">
  </div>
  <div class="error-msg" id="error-msg"></div>
  <button class="btn-join" onclick="joinRoom()">Приєднатись</button>
</div>

<!-- WAITING -->
<div id="screen-waiting" class="screen">
  <div class="waiting-icon" id="waiting-icon">?</div>
  <div class="waiting-name" id="waiting-name">Ваше ім'я</div>
  <div class="waiting-sub"><span class="status-dot"></span>Очікуємо початку гри...</div>
</div>

<!-- TOPIC SELECT -->
<div id="screen-topic" class="screen">
  <div class="phase-top">
    <div class="phase-tag">Фаза 1</div>
    <div class="phase-h">Оберіть тему</div>
    <div class="phase-sub">Захищайте свою позицію за допомогою софізмів</div>
  </div>
  <div class="topics-list" id="topics-list"></div>
</div>

<!-- TOPIC CHOSEN -->
<div id="screen-topic-done" class="screen">
  <div class="phase-top">
    <div class="phase-tag">Тема обрана ✓</div>
    <div class="phase-h">Чудово!</div>
  </div>
  <div class="chosen-topic" id="chosen-topic-display"></div>
  <div class="waiting-sub" style="text-align:center"><span class="status-dot"></span>Чекаємо інших гравців...</div>
</div>

<!-- FALLACY DEAL -->
<div id="screen-fallacy" class="screen">
  <div class="phase-top">
    <div class="phase-tag">Фаза 2 — Ваші картки</div>
    <div class="phase-h">Готуйте промову</div>
  </div>
  <div class="topic-reminder" id="topic-reminder-box">
    <div class="topic-reminder-label">Ваша тема</div>
    <div class="topic-reminder-text" id="topic-reminder-text"></div>
  </div>
  <div class="fallacy-cards" id="fallacy-cards"></div>
</div>

<!-- VOTE -->
<div id="screen-vote" class="screen">
  <div class="phase-top">
    <div class="phase-tag">Фаза 4 — Голосування</div>
    <div class="phase-h">Хто найкраще?</div>
    <div class="phase-sub">Голосуйте за найсильнішого спікера</div>
  </div>
  <div class="vote-list" id="vote-list"></div>
</div>

<!-- MAP -->
<div id="screen-map" class="screen">
  <div class="phase-top">
    <div class="phase-tag">Фаза 5 — Захват</div>
    <div class="phase-h">Карта світу</div>
  </div>
  <div class="capture-info">
    <div>
      <div class="capture-pts-label">Очки для захвату</div>
      <div class="capture-pts" id="capture-pts">0</div>
    </div>
    <div style="font-size:0.8rem; color:var(--muted); max-width:160px; text-align:right">
      Натискайте на клітинки щоб захопити їх
    </div>
  </div>
  <div class="map-grid-phone" id="map-grid-phone"></div>
  <button class="btn-capture" id="btn-capture" onclick="confirmCapture()" disabled>Захопити вибране</button>
</div>

<!-- RESULT (waiting between rounds) -->
<div id="screen-result" class="screen">
  <div class="result-big" id="result-pts">+0</div>
  <div class="result-msg">очки за цей раунд</div>
  <div style="margin-top:1rem; color:var(--muted); font-size:0.85rem">
    <span class="status-dot"></span>Раунд завершується...
  </div>
</div>

<script>
const WS_URL = location.protocol === 'https:'
  ? `wss://${location.host}/ws`
  : `ws://${location.host}/ws`;

let ws, playerId, myColor, myName;
let capturePoints = 0, selectedCells = [], mapData = null, players = {};
let myVote = null, myTopic = null;

// ── CONNECT ──────────────────────────────────────────────────────────────────
function connect() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => console.log("WS connected:", WS_URL);
  ws.onmessage = e => handle(JSON.parse(e.data));
  ws.onerror = () => showError("Помилка підключення до сервера");
  ws.onclose = (e) => {
    showError("З'єднання втрачено ("+e.code+"). Перепідключення...");
    setTimeout(connect, 3000);
  };
}

function send(obj) {
  if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(obj));
}

// ── JOIN ──────────────────────────────────────────────────────────────────────
function joinRoom() {
  const code = document.getElementById('code-input').value.trim().toUpperCase();
  const name = document.getElementById('name-input').value.trim() || 'Гравець';
  if (code.length < 4) { showError('Введіть 4-літерний код'); return; }

  myName = name;
  send({ type: 'join_room', code, name });
}

function showError(msg) {
  document.getElementById('error-msg').textContent = msg;
  setTimeout(() => document.getElementById('error-msg').textContent = '', 3000);
}

// ── HANDLE ────────────────────────────────────────────────────────────────────
function handle(msg) {
  switch(msg.type) {
    case 'joined':
      playerId = msg.playerId;
      myColor = msg.color;
      document.documentElement.style.setProperty('--my-color', myColor);
      showScreen('screen-waiting');
      document.getElementById('waiting-icon').textContent = myName.charAt(0).toUpperCase();
      document.getElementById('waiting-icon').style.background = myColor;
      document.getElementById('waiting-name').textContent = myName;
      break;

    case 'player_joined':
      updatePlayers(msg.players);
      break;

    case 'error':
      showError(msg.msg);
      break;

    case 'topic_options':
      showScreen('screen-topic');
      renderTopics(msg.topics);
      break;

    case 'topic_chosen':
      myTopic = msg.topic;
      document.getElementById('chosen-topic-display').textContent = msg.topic;
      showScreen('screen-topic-done');
      break;

    case 'fallacy_deal':
      myTopic = msg.yourTopic;
      document.getElementById('topic-reminder-text').textContent = msg.yourTopic;
      renderFallacyCards(msg.cards);
      showScreen('screen-fallacy');
      break;

    case 'phase':
      handlePhase(msg);
      break;

    case 'vote_cast':
      markVoteCast();
      break;

    case 'vote_result':
      const myPts = msg.roundScores[playerId] || 0;
      document.getElementById('result-pts').textContent = `+${myPts}`;
      showScreen('screen-result');
      break;

    case 'map_turn':
      capturePoints = msg.capturePoints;
      mapData = msg.map;
      selectedCells = [];
      document.getElementById('capture-pts').textContent = capturePoints;
      renderMapPhone();
      showScreen('screen-map');
      break;

    case 'map_update':
      mapData = msg.map;
      renderMapPhone();
      break;
  }
}

function updatePlayers(list) {
  players = {};
  list.forEach(p => players[p.id] = p);
}

function handlePhase(msg) {
  if (msg.phase === 'speech') {
    showScreen('screen-fallacy'); // keep fallacy cards visible during speech
  }
  if (msg.phase === 'vote') {
    renderVoteList(msg.players || []);
    showScreen('screen-vote');
  }
  if (msg.phase === 'round_end') {
    showScreen('screen-result');
  }
  if (msg.phase === 'topic_select') {
    myTopic = null; myVote = null; selectedCells = [];
    // topic_options will come separately
  }
}

// ── TOPICS ────────────────────────────────────────────────────────────────────
function renderTopics(topics) {
  const list = document.getElementById('topics-list');
  list.innerHTML = topics.map((t, i) => `
    <button class="topic-btn" onclick="chooseTopic(${i}, this)">
      <span>${t}</span>
    </button>
  `).join('');
  list._topics = topics;
}

function chooseTopic(idx, btn) {
  const topic = document.getElementById('topics-list')._topics[idx];
  document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  send({ type: 'choose_topic', topic });
}

// ── FALLACY CARDS ─────────────────────────────────────────────────────────────
function renderFallacyCards(cards) {
  const el = document.getElementById('fallacy-cards');
  el.innerHTML = cards.map((c, i) => `
    <div class="fallacy-card">
      <div class="fallacy-num">${i + 1}</div>
      <div class="fallacy-info">
        <div class="fallacy-name">${c.name}</div>
        <div class="fallacy-desc">${c.desc}</div>
      </div>
    </div>
  `).join('');
}

// ── VOTE ──────────────────────────────────────────────────────────────────────
function renderVoteList(playerList) {
  myVote = null;
  const el = document.getElementById('vote-list');
  el.innerHTML = playerList
    .filter(p => p.id !== playerId)
    .map(p => `
      <button class="vote-btn" id="vote-${p.id}" onclick="castVote('${p.id}', this)">
        <div style="width:14px;height:14px;border-radius:50%;background:${p.color};flex-shrink:0"></div>
        ${p.name}
      </button>
    `).join('');
}

function castVote(targetId, btn) {
  if (myVote) return;
  myVote = targetId;
  send({ type: 'vote', targetId });
  document.querySelectorAll('.vote-btn').forEach(b => {
    b.classList.add('voted');
  });
  btn.classList.add('my-vote');
}

function markVoteCast() {
  document.querySelectorAll('.vote-btn').forEach(b => b.classList.add('voted'));
}

// ── MAP ───────────────────────────────────────────────────────────────────────
function isAdjacentToMe(cellId) {
  if (!mapData) return false;
  const cell = mapData.cells.find(c => c.id === cellId);
  if (!cell || cell.owner === playerId) return false;
  return [
    { row: cell.row - 1, col: cell.col },
    { row: cell.row + 1, col: cell.col },
    { row: cell.row,     col: cell.col - 1 },
    { row: cell.row,     col: cell.col + 1 },
  ].some(n => {
    const nb = mapData.cells.find(c => c.row === n.row && c.col === n.col);
    return nb && nb.owner === playerId;
  });
}

function renderMapPhone() {
  if (!mapData) return;
  const grid = document.getElementById('map-grid-phone');
  grid.innerHTML = mapData.cells.map(cell => {
    const owner = cell.owner ? players[cell.owner] : null;
    const bg = owner ? owner.color : 'var(--border)';
    const isMe = cell.owner === playerId;
    const isSelected = selectedCells.includes(cell.id);
    const adjacent = !isMe && capturePoints > 0 && isAdjacentToMe(cell.id);
    const cls = [
      isMe ? 'mine' : '',
      adjacent ? 'capturable' : '',
      isSelected ? 'selected' : '',
    ].filter(Boolean).join(' ');

    return `<div class="map-cell-phone ${cls}"
      style="background:${bg}"
      data-id="${cell.id}"
      onclick="toggleCell(${cell.id})"></div>`;
  }).join('');
}

function toggleCell(cellId) {
  if (capturePoints <= 0) return;
  const cell = mapData.cells.find(c => c.id === cellId);
  if (!cell || cell.owner === playerId) return;
  if (!isAdjacentToMe(cellId)) return; // тільки прилеглі

  const idx = selectedCells.indexOf(cellId);
  if (idx >= 0) {
    selectedCells.splice(idx, 1);
  } else {
    if (selectedCells.length >= capturePoints) return;
    selectedCells.push(cellId);
  }
  renderMapPhone();
  document.getElementById('btn-capture').disabled = selectedCells.length === 0;
}

function confirmCapture() {
  if (selectedCells.length === 0) return;
  send({ type: 'capture', cellIds: selectedCells });
  capturePoints -= selectedCells.length;
  selectedCells = [];
  document.getElementById('capture-pts').textContent = capturePoints;
  document.getElementById('btn-capture').disabled = true;
}

// ── SCREENS ───────────────────────────────────────────────────────────────────
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-join').style.display = 'none';
  const target = document.getElementById(id);
  if (target) target.classList.add('active');
}

// ── INIT ──────────────────────────────────────────────────────────────────────
connect();
</script>
</body>
</html>